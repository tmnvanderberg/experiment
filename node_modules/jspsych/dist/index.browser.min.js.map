{"version":3,"file":"index.browser.min.js","sources":["../../../node_modules/tslib/tslib.es6.js","../../../node_modules/auto-bind/index.js","../src/modules/utils.ts","../src/modules/plugins.ts","../src/modules/data/DataColumn.ts","../src/modules/data/DataCollection.ts","../src/modules/data/utils.ts","../src/modules/data/index.ts","../src/modules/plugin-api/HardwareAPI.ts","../src/modules/plugin-api/KeyboardListenerAPI.ts","../src/modules/plugin-api/MediaAPI.ts","../src/modules/plugin-api/TimeoutAPI.ts","../src/modules/randomization.ts","../src/modules/turk.ts","../src/TimelineNode.ts","../src/JsPsych.ts","../src/modules/plugin-api/index.ts","../src/index.ts"],"sourcesContent":["/*! *****************************************************************************\r\nCopyright (c) Microsoft Corporation.\r\n\r\nPermission to use, copy, modify, and/or distribute this software for any\r\npurpose with or without fee is hereby granted.\r\n\r\nTHE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH\r\nREGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY\r\nAND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,\r\nINDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM\r\nLOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR\r\nOTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR\r\nPERFORMANCE OF THIS SOFTWARE.\r\n***************************************************************************** */\r\n/* global Reflect, Promise */\r\n\r\nvar extendStatics = function(d, b) {\r\n    extendStatics = Object.setPrototypeOf ||\r\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\r\n        function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };\r\n    return extendStatics(d, b);\r\n};\r\n\r\nexport function __extends(d, b) {\r\n    if (typeof b !== \"function\" && b !== null)\r\n        throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\r\n    extendStatics(d, b);\r\n    function __() { this.constructor = d; }\r\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\r\n}\r\n\r\nexport var __assign = function() {\r\n    __assign = Object.assign || function __assign(t) {\r\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\r\n            s = arguments[i];\r\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\r\n        }\r\n        return t;\r\n    }\r\n    return __assign.apply(this, arguments);\r\n}\r\n\r\nexport function __rest(s, e) {\r\n    var t = {};\r\n    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)\r\n        t[p] = s[p];\r\n    if (s != null && typeof Object.getOwnPropertySymbols === \"function\")\r\n        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\r\n            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))\r\n                t[p[i]] = s[p[i]];\r\n        }\r\n    return t;\r\n}\r\n\r\nexport function __decorate(decorators, target, key, desc) {\r\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\r\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\r\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\r\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\r\n}\r\n\r\nexport function __param(paramIndex, decorator) {\r\n    return function (target, key) { decorator(target, key, paramIndex); }\r\n}\r\n\r\nexport function __metadata(metadataKey, metadataValue) {\r\n    if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(metadataKey, metadataValue);\r\n}\r\n\r\nexport function __awaiter(thisArg, _arguments, P, generator) {\r\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n}\r\n\r\nexport function __generator(thisArg, body) {\r\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\r\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\r\n    function verb(n) { return function (v) { return step([n, v]); }; }\r\n    function step(op) {\r\n        if (f) throw new TypeError(\"Generator is already executing.\");\r\n        while (_) try {\r\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\r\n            if (y = 0, t) op = [op[0] & 2, t.value];\r\n            switch (op[0]) {\r\n                case 0: case 1: t = op; break;\r\n                case 4: _.label++; return { value: op[1], done: false };\r\n                case 5: _.label++; y = op[1]; op = [0]; continue;\r\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\r\n                default:\r\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\r\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\r\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\r\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\r\n                    if (t[2]) _.ops.pop();\r\n                    _.trys.pop(); continue;\r\n            }\r\n            op = body.call(thisArg, _);\r\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\r\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\r\n    }\r\n}\r\n\r\nexport var __createBinding = Object.create ? (function(o, m, k, k2) {\r\n    if (k2 === undefined) k2 = k;\r\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\r\n}) : (function(o, m, k, k2) {\r\n    if (k2 === undefined) k2 = k;\r\n    o[k2] = m[k];\r\n});\r\n\r\nexport function __exportStar(m, o) {\r\n    for (var p in m) if (p !== \"default\" && !Object.prototype.hasOwnProperty.call(o, p)) __createBinding(o, m, p);\r\n}\r\n\r\nexport function __values(o) {\r\n    var s = typeof Symbol === \"function\" && Symbol.iterator, m = s && o[s], i = 0;\r\n    if (m) return m.call(o);\r\n    if (o && typeof o.length === \"number\") return {\r\n        next: function () {\r\n            if (o && i >= o.length) o = void 0;\r\n            return { value: o && o[i++], done: !o };\r\n        }\r\n    };\r\n    throw new TypeError(s ? \"Object is not iterable.\" : \"Symbol.iterator is not defined.\");\r\n}\r\n\r\nexport function __read(o, n) {\r\n    var m = typeof Symbol === \"function\" && o[Symbol.iterator];\r\n    if (!m) return o;\r\n    var i = m.call(o), r, ar = [], e;\r\n    try {\r\n        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);\r\n    }\r\n    catch (error) { e = { error: error }; }\r\n    finally {\r\n        try {\r\n            if (r && !r.done && (m = i[\"return\"])) m.call(i);\r\n        }\r\n        finally { if (e) throw e.error; }\r\n    }\r\n    return ar;\r\n}\r\n\r\n/** @deprecated */\r\nexport function __spread() {\r\n    for (var ar = [], i = 0; i < arguments.length; i++)\r\n        ar = ar.concat(__read(arguments[i]));\r\n    return ar;\r\n}\r\n\r\n/** @deprecated */\r\nexport function __spreadArrays() {\r\n    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\r\n    for (var r = Array(s), k = 0, i = 0; i < il; i++)\r\n        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)\r\n            r[k] = a[j];\r\n    return r;\r\n}\r\n\r\nexport function __spreadArray(to, from, pack) {\r\n    if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {\r\n        if (ar || !(i in from)) {\r\n            if (!ar) ar = Array.prototype.slice.call(from, 0, i);\r\n            ar[i] = from[i];\r\n        }\r\n    }\r\n    return to.concat(ar || Array.prototype.slice.call(from));\r\n}\r\n\r\nexport function __await(v) {\r\n    return this instanceof __await ? (this.v = v, this) : new __await(v);\r\n}\r\n\r\nexport function __asyncGenerator(thisArg, _arguments, generator) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var g = generator.apply(thisArg, _arguments || []), i, q = [];\r\n    return i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i;\r\n    function verb(n) { if (g[n]) i[n] = function (v) { return new Promise(function (a, b) { q.push([n, v, a, b]) > 1 || resume(n, v); }); }; }\r\n    function resume(n, v) { try { step(g[n](v)); } catch (e) { settle(q[0][3], e); } }\r\n    function step(r) { r.value instanceof __await ? Promise.resolve(r.value.v).then(fulfill, reject) : settle(q[0][2], r); }\r\n    function fulfill(value) { resume(\"next\", value); }\r\n    function reject(value) { resume(\"throw\", value); }\r\n    function settle(f, v) { if (f(v), q.shift(), q.length) resume(q[0][0], q[0][1]); }\r\n}\r\n\r\nexport function __asyncDelegator(o) {\r\n    var i, p;\r\n    return i = {}, verb(\"next\"), verb(\"throw\", function (e) { throw e; }), verb(\"return\"), i[Symbol.iterator] = function () { return this; }, i;\r\n    function verb(n, f) { i[n] = o[n] ? function (v) { return (p = !p) ? { value: __await(o[n](v)), done: n === \"return\" } : f ? f(v) : v; } : f; }\r\n}\r\n\r\nexport function __asyncValues(o) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var m = o[Symbol.asyncIterator], i;\r\n    return m ? m.call(o) : (o = typeof __values === \"function\" ? __values(o) : o[Symbol.iterator](), i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i);\r\n    function verb(n) { i[n] = o[n] && function (v) { return new Promise(function (resolve, reject) { v = o[n](v), settle(resolve, reject, v.done, v.value); }); }; }\r\n    function settle(resolve, reject, d, v) { Promise.resolve(v).then(function(v) { resolve({ value: v, done: d }); }, reject); }\r\n}\r\n\r\nexport function __makeTemplateObject(cooked, raw) {\r\n    if (Object.defineProperty) { Object.defineProperty(cooked, \"raw\", { value: raw }); } else { cooked.raw = raw; }\r\n    return cooked;\r\n};\r\n\r\nvar __setModuleDefault = Object.create ? (function(o, v) {\r\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\r\n}) : function(o, v) {\r\n    o[\"default\"] = v;\r\n};\r\n\r\nexport function __importStar(mod) {\r\n    if (mod && mod.__esModule) return mod;\r\n    var result = {};\r\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\r\n    __setModuleDefault(result, mod);\r\n    return result;\r\n}\r\n\r\nexport function __importDefault(mod) {\r\n    return (mod && mod.__esModule) ? mod : { default: mod };\r\n}\r\n\r\nexport function __classPrivateFieldGet(receiver, state, kind, f) {\r\n    if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a getter\");\r\n    if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot read private member from an object whose class did not declare it\");\r\n    return kind === \"m\" ? f : kind === \"a\" ? f.call(receiver) : f ? f.value : state.get(receiver);\r\n}\r\n\r\nexport function __classPrivateFieldSet(receiver, state, value, kind, f) {\r\n    if (kind === \"m\") throw new TypeError(\"Private method is not writable\");\r\n    if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a setter\");\r\n    if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot write private member to an object whose class did not declare it\");\r\n    return (kind === \"a\" ? f.call(receiver, value) : f ? f.value = value : state.set(receiver, value)), value;\r\n}\r\n","'use strict';\n\n// Gets all non-builtin properties up the prototype chain\nconst getAllProperties = object => {\n\tconst properties = new Set();\n\n\tdo {\n\t\tfor (const key of Reflect.ownKeys(object)) {\n\t\t\tproperties.add([object, key]);\n\t\t}\n\t} while ((object = Reflect.getPrototypeOf(object)) && object !== Object.prototype);\n\n\treturn properties;\n};\n\nmodule.exports = (self, {include, exclude} = {}) => {\n\tconst filter = key => {\n\t\tconst match = pattern => typeof pattern === 'string' ? key === pattern : pattern.test(key);\n\n\t\tif (include) {\n\t\t\treturn include.some(match);\n\t\t}\n\n\t\tif (exclude) {\n\t\t\treturn !exclude.some(match);\n\t\t}\n\n\t\treturn true;\n\t};\n\n\tfor (const [object, key] of getAllProperties(self.constructor.prototype)) {\n\t\tif (key === 'constructor' || !filter(key)) {\n\t\t\tcontinue;\n\t\t}\n\n\t\tconst descriptor = Reflect.getOwnPropertyDescriptor(object, key);\n\t\tif (descriptor && typeof descriptor.value === 'function') {\n\t\t\tself[key] = self[key].bind(self);\n\t\t}\n\t}\n\n\treturn self;\n};\n","/**\n * Finds all of the unique items in an array.\n * @param arr The array to extract unique values from\n * @returns An array with one copy of each unique item in `arr`\n */\nexport function unique(arr: Array<any>) {\n  return [...new Set(arr)];\n}\n\nexport function deepCopy(obj) {\n  if (!obj) return obj;\n  let out;\n  if (Array.isArray(obj)) {\n    out = [];\n    for (const x of obj) {\n      out.push(deepCopy(x));\n    }\n    return out;\n  } else if (typeof obj === \"object\" && obj !== null) {\n    out = {};\n    for (const key in obj) {\n      if (obj.hasOwnProperty(key)) {\n        out[key] = deepCopy(obj[key]);\n      }\n    }\n    return out;\n  } else {\n    return obj;\n  }\n}\n","/**\nFlatten the type output to improve type hints shown in editors.\nBorrowed from type-fest\n*/\ntype Simplify<T> = { [KeyType in keyof T]: T[KeyType] };\n\n/**\nCreate a type that makes the given keys required. The remaining keys are kept as is.\nBorrowed from type-fest\n*/\ntype SetRequired<BaseType, Keys extends keyof BaseType> = Simplify<\n  Omit<BaseType, Keys> & Required<Pick<BaseType, Keys>>\n>;\n\n/**\n * Parameter types for plugins\n */\nexport enum ParameterType {\n  BOOL,\n  STRING,\n  INT,\n  FLOAT,\n  FUNCTION,\n  KEY,\n  KEYS,\n  SELECT,\n  HTML_STRING,\n  IMAGE,\n  AUDIO,\n  VIDEO,\n  OBJECT,\n  COMPLEX,\n  TIMELINE,\n}\n\ntype ParameterTypeMap = {\n  [ParameterType.BOOL]: boolean;\n  [ParameterType.STRING]: string;\n  [ParameterType.INT]: number;\n  [ParameterType.FLOAT]: number;\n  [ParameterType.FUNCTION]: (...args: any[]) => any;\n  [ParameterType.KEY]: string;\n  [ParameterType.KEYS]: string[] | \"ALL_KEYS\" | \"NO_KEYS\";\n  [ParameterType.SELECT]: any;\n  [ParameterType.HTML_STRING]: string;\n  [ParameterType.IMAGE]: string;\n  [ParameterType.AUDIO]: string;\n  [ParameterType.VIDEO]: string;\n  [ParameterType.OBJECT]: object;\n  [ParameterType.COMPLEX]: any;\n  [ParameterType.TIMELINE]: any;\n};\n\nexport interface ParameterInfo {\n  type: ParameterType;\n  array?: boolean;\n  pretty_name?: string;\n  default?: any;\n  preload?: boolean;\n}\n\nexport interface ParameterInfos {\n  [key: string]: ParameterInfo;\n}\n\ntype InferredParameter<I extends ParameterInfo> = I[\"array\"] extends true\n  ? Array<ParameterTypeMap[I[\"type\"]]>\n  : ParameterTypeMap[I[\"type\"]];\n\ntype RequiredParameterNames<I extends ParameterInfos> = {\n  [K in keyof I]: I[K][\"default\"] extends undefined ? K : never;\n}[keyof I];\n\ntype InferredParameters<I extends ParameterInfos> = SetRequired<\n  {\n    [Property in keyof I]?: InferredParameter<I[Property]>;\n  },\n  RequiredParameterNames<I>\n>;\n\nexport const universalPluginParameters = <const>{\n  /**\n   * Data to add to this trial (key-value pairs)\n   */\n  data: {\n    type: ParameterType.OBJECT,\n    pretty_name: \"Data\",\n    default: {},\n  },\n  /**\n   * Function to execute when trial begins\n   */\n  on_start: {\n    type: ParameterType.FUNCTION,\n    pretty_name: \"On start\",\n    default: function () {\n      return;\n    },\n  },\n  /**\n   * Function to execute when trial is finished\n   */\n  on_finish: {\n    type: ParameterType.FUNCTION,\n    pretty_name: \"On finish\",\n    default: function () {\n      return;\n    },\n  },\n  /**\n   * Function to execute after the trial has loaded\n   */\n  on_load: {\n    type: ParameterType.FUNCTION,\n    pretty_name: \"On load\",\n    default: function () {\n      return;\n    },\n  },\n  /**\n   * Length of gap between the end of this trial and the start of the next trial\n   */\n  post_trial_gap: {\n    type: ParameterType.INT,\n    pretty_name: \"Post trial gap\",\n    default: null,\n  },\n  /**\n   * A list of CSS classes to add to the jsPsych display element for the duration of this trial\n   */\n  css_classes: {\n    type: ParameterType.STRING,\n    pretty_name: \"Custom CSS classes\",\n    default: null,\n  },\n};\n\nexport type UniversalPluginParameters = InferredParameters<typeof universalPluginParameters>;\n\nexport interface PluginInfo {\n  name: string;\n  parameters: {\n    [key: string]: ParameterInfo;\n  };\n}\n\nexport interface JsPsychPlugin<I extends PluginInfo> {\n  trial(\n    display_element: HTMLElement,\n    trial: TrialType<I>,\n    on_load?: () => void\n  ): void | Promise<any>;\n}\n\nexport type TrialType<I extends PluginInfo> = InferredParameters<I[\"parameters\"]> &\n  UniversalPluginParameters;\n\nexport type PluginParameters<I extends PluginInfo> = InferredParameters<I[\"parameters\"]>;\n","export class DataColumn {\n  constructor(public values = []) {}\n\n  sum() {\n    let s = 0;\n    for (const v of this.values) {\n      s += v;\n    }\n    return s;\n  }\n\n  mean() {\n    return this.sum() / this.count();\n  }\n\n  median() {\n    if (this.values.length === 0) {\n      return undefined;\n    }\n    const numbers = this.values.slice(0).sort(function (a, b) {\n      return a - b;\n    });\n    const middle = Math.floor(numbers.length / 2);\n    const isEven = numbers.length % 2 === 0;\n    return isEven ? (numbers[middle] + numbers[middle - 1]) / 2 : numbers[middle];\n  }\n\n  min() {\n    return Math.min.apply(null, this.values);\n  }\n\n  max() {\n    return Math.max.apply(null, this.values);\n  }\n\n  count() {\n    return this.values.length;\n  }\n\n  variance() {\n    const mean = this.mean();\n    let sum_square_error = 0;\n    for (const x of this.values) {\n      sum_square_error += Math.pow(x - mean, 2);\n    }\n    const mse = sum_square_error / (this.values.length - 1);\n    return mse;\n  }\n\n  sd() {\n    const mse = this.variance();\n    const rmse = Math.sqrt(mse);\n    return rmse;\n  }\n\n  frequencies() {\n    const unique = {};\n    for (const x of this.values) {\n      if (typeof unique[x] === \"undefined\") {\n        unique[x] = 1;\n      } else {\n        unique[x]++;\n      }\n    }\n    return unique;\n  }\n\n  all(eval_fn) {\n    for (const x of this.values) {\n      if (!eval_fn(x)) {\n        return false;\n      }\n    }\n    return true;\n  }\n\n  subset(eval_fn) {\n    const out = [];\n    for (const x of this.values) {\n      if (eval_fn(x)) {\n        out.push(x);\n      }\n    }\n    return new DataColumn(out);\n  }\n}\n","import { deepCopy } from \"../utils\";\nimport { DataColumn } from \"./DataColumn\";\nimport { JSON2CSV, saveTextToFile } from \"./utils\";\n\nexport class DataCollection {\n  private trials: any[];\n\n  constructor(data = []) {\n    this.trials = data;\n  }\n\n  push(new_data) {\n    this.trials.push(new_data);\n    return this;\n  }\n\n  join(other_data_collection: DataCollection) {\n    this.trials = this.trials.concat(other_data_collection.values());\n    return this;\n  }\n\n  top() {\n    if (this.trials.length <= 1) {\n      return this;\n    } else {\n      return new DataCollection([this.trials[this.trials.length - 1]]);\n    }\n  }\n\n  /**\n   * Queries the first n elements in a collection of trials.\n   *\n   * @param n A positive integer of elements to return. A value of\n   *          n that is less than 1 will throw an error.\n   *\n   * @return First n objects of a collection of trials. If fewer than\n   *         n trials are available, the trials.length elements will\n   *         be returned.\n   *\n   */\n  first(n = 1) {\n    if (n < 1) {\n      throw `You must query with a positive nonzero integer. Please use a\n               different value for n.`;\n    }\n    if (this.trials.length === 0) return new DataCollection();\n    if (n > this.trials.length) n = this.trials.length;\n    return new DataCollection(this.trials.slice(0, n));\n  }\n\n  /**\n   * Queries the last n elements in a collection of trials.\n   *\n   * @param n A positive integer of elements to return. A value of\n   *          n that is less than 1 will throw an error.\n   *\n   * @return Last n objects of a collection of trials. If fewer than\n   *         n trials are available, the trials.length elements will\n   *         be returned.\n   *\n   */\n  last(n = 1) {\n    if (n < 1) {\n      throw `You must query with a positive nonzero integer. Please use a\n               different value for n.`;\n    }\n    if (this.trials.length === 0) return new DataCollection();\n    if (n > this.trials.length) n = this.trials.length;\n    return new DataCollection(this.trials.slice(this.trials.length - n, this.trials.length));\n  }\n\n  values() {\n    return this.trials;\n  }\n\n  count() {\n    return this.trials.length;\n  }\n\n  readOnly() {\n    return new DataCollection(deepCopy(this.trials));\n  }\n\n  addToAll(properties) {\n    for (const trial of this.trials) {\n      Object.assign(trial, properties);\n    }\n    return this;\n  }\n\n  addToLast(properties) {\n    if (this.trials.length != 0) {\n      Object.assign(this.trials[this.trials.length - 1], properties);\n    }\n    return this;\n  }\n\n  filter(filters) {\n    // [{p1: v1, p2:v2}, {p1:v2}]\n    // {p1: v1}\n    let f;\n    if (!Array.isArray(filters)) {\n      f = deepCopy([filters]);\n    } else {\n      f = deepCopy(filters);\n    }\n\n    const filtered_data = [];\n    for (const trial of this.trials) {\n      let keep = false;\n      for (const filter of f) {\n        let match = true;\n        for (const key of Object.keys(filter)) {\n          if (typeof trial[key] !== \"undefined\" && trial[key] === filter[key]) {\n            // matches on this key!\n          } else {\n            match = false;\n          }\n        }\n        if (match) {\n          keep = true;\n          break;\n        } // can break because each filter is OR.\n      }\n      if (keep) {\n        filtered_data.push(trial);\n      }\n    }\n\n    return new DataCollection(filtered_data);\n  }\n\n  filterCustom(fn) {\n    return new DataCollection(this.trials.filter(fn));\n  }\n\n  select(column) {\n    const values = [];\n    for (const trial of this.trials) {\n      if (typeof trial[column] !== \"undefined\") {\n        values.push(trial[column]);\n      }\n    }\n    return new DataColumn(values);\n  }\n\n  ignore(columns) {\n    if (!Array.isArray(columns)) {\n      columns = [columns];\n    }\n    const o = deepCopy(this.trials);\n    for (const trial of o) {\n      for (const delete_key of columns) {\n        delete trial[delete_key];\n      }\n    }\n    return new DataCollection(o);\n  }\n\n  uniqueNames() {\n    const names = [];\n\n    for (const trial of this.trials) {\n      for (const key of Object.keys(trial)) {\n        if (!names.includes(key)) {\n          names.push(key);\n        }\n      }\n    }\n\n    return names;\n  }\n\n  csv() {\n    return JSON2CSV(this.trials);\n  }\n\n  json(pretty = false) {\n    if (pretty) {\n      return JSON.stringify(this.trials, null, \"\\t\");\n    }\n    return JSON.stringify(this.trials);\n  }\n\n  localSave(format, filename) {\n    format = format.toLowerCase();\n    let data_string;\n    if (format === \"json\") {\n      data_string = this.json();\n    } else if (format === \"csv\") {\n      data_string = this.csv();\n    } else {\n      throw new Error('Invalid format specified for localSave. Must be \"json\" or \"csv\".');\n    }\n\n    saveTextToFile(data_string, filename);\n  }\n}\n","// private function to save text file on local drive\nexport function saveTextToFile(textstr: string, filename: string) {\n  const blobToSave = new Blob([textstr], {\n    type: \"text/plain\",\n  });\n  let blobURL = \"\";\n  if (typeof window.webkitURL !== \"undefined\") {\n    blobURL = window.webkitURL.createObjectURL(blobToSave);\n  } else {\n    blobURL = window.URL.createObjectURL(blobToSave);\n  }\n\n  const link = document.createElement(\"a\");\n  link.id = \"jspsych-download-as-text-link\";\n  link.style.display = \"none\";\n  link.download = filename;\n  link.href = blobURL;\n  link.click();\n}\n\n// this function based on code suggested by StackOverflow users:\n// http://stackoverflow.com/users/64741/zachary\n// http://stackoverflow.com/users/317/joseph-sturtevant\n\nexport function JSON2CSV(objArray) {\n  const array = typeof objArray != \"object\" ? JSON.parse(objArray) : objArray;\n  let line = \"\";\n  let result = \"\";\n  const columns = [];\n\n  for (const row of array) {\n    for (const key in row) {\n      let keyString = key + \"\";\n      keyString = '\"' + keyString.replace(/\"/g, '\"\"') + '\",';\n      if (!columns.includes(key)) {\n        columns.push(key);\n        line += keyString;\n      }\n    }\n  }\n\n  line = line.slice(0, -1); // removes last comma\n  result += line + \"\\r\\n\";\n\n  for (const row of array) {\n    line = \"\";\n    for (const col of columns) {\n      let value = typeof row[col] === \"undefined\" ? \"\" : row[col];\n      if (typeof value == \"object\") {\n        value = JSON.stringify(value);\n      }\n      const valueString = value + \"\";\n      line += '\"' + valueString.replace(/\"/g, '\"\"') + '\",';\n    }\n\n    line = line.slice(0, -1);\n    result += line + \"\\r\\n\";\n  }\n\n  return result;\n}\n\n// this function is modified from StackOverflow:\n// http://stackoverflow.com/posts/3855394\n\nexport function getQueryString() {\n  const a = window.location.search.substr(1).split(\"&\");\n  const b = {};\n  for (let i = 0; i < a.length; ++i) {\n    const p = a[i].split(\"=\", 2);\n    if (p.length == 1) b[p[0]] = \"\";\n    else b[p[0]] = decodeURIComponent(p[1].replace(/\\+/g, \" \"));\n  }\n  return b;\n}\n","import { JsPsych } from \"../../JsPsych\";\nimport { DataCollection } from \"./DataCollection\";\nimport { getQueryString } from \"./utils\";\n\nexport class JsPsychData {\n  // data storage object\n  private allData: DataCollection;\n\n  // browser interaction event data\n  private interactionData: DataCollection;\n\n  // data properties for all trials\n  private dataProperties = {};\n\n  // cache the query_string\n  private query_string;\n\n  constructor(private jsPsych: JsPsych) {\n    this.reset();\n  }\n\n  reset() {\n    this.allData = new DataCollection();\n    this.interactionData = new DataCollection();\n  }\n\n  get() {\n    return this.allData;\n  }\n\n  getInteractionData() {\n    return this.interactionData;\n  }\n\n  write(data_object) {\n    const progress = this.jsPsych.getProgress();\n    const trial = this.jsPsych.getCurrentTrial();\n\n    //var trial_opt_data = typeof trial.data == 'function' ? trial.data() : trial.data;\n\n    const default_data = {\n      trial_type: trial.type.info.name,\n      trial_index: progress.current_trial_global,\n      time_elapsed: this.jsPsych.getTotalTime(),\n      internal_node_id: this.jsPsych.getCurrentTimelineNodeID(),\n    };\n\n    this.allData.push({\n      ...data_object,\n      ...trial.data,\n      ...default_data,\n      ...this.dataProperties,\n    });\n  }\n\n  addProperties(properties) {\n    // first, add the properties to all data that's already stored\n    this.allData.addToAll(properties);\n\n    // now add to list so that it gets appended to all future data\n    this.dataProperties = Object.assign({}, this.dataProperties, properties);\n  }\n\n  addDataToLastTrial(data) {\n    this.allData.addToLast(data);\n  }\n\n  getDataByTimelineNode(node_id) {\n    return this.allData.filterCustom(\n      (x) => x.internal_node_id.slice(0, node_id.length) === node_id\n    );\n  }\n\n  getLastTrialData() {\n    return this.allData.top();\n  }\n\n  getLastTimelineData() {\n    const lasttrial = this.getLastTrialData();\n    const node_id = lasttrial.select(\"internal_node_id\").values[0];\n    if (typeof node_id === \"undefined\") {\n      return new DataCollection();\n    } else {\n      const parent_node_id = node_id.substr(0, node_id.lastIndexOf(\"-\"));\n      const lastnodedata = this.getDataByTimelineNode(parent_node_id);\n      return lastnodedata;\n    }\n  }\n\n  displayData(format = \"json\") {\n    format = format.toLowerCase();\n    if (format != \"json\" && format != \"csv\") {\n      console.log(\"Invalid format declared for displayData function. Using json as default.\");\n      format = \"json\";\n    }\n\n    const data_string = format === \"json\" ? this.allData.json(true) : this.allData.csv();\n\n    const display_element = this.jsPsych.getDisplayElement();\n\n    display_element.innerHTML = '<pre id=\"jspsych-data-display\"></pre>';\n\n    document.getElementById(\"jspsych-data-display\").textContent = data_string;\n  }\n\n  urlVariables() {\n    if (typeof this.query_string == \"undefined\") {\n      this.query_string = getQueryString();\n    }\n    return this.query_string;\n  }\n\n  getURLVariable(whichvar) {\n    return this.urlVariables()[whichvar];\n  }\n\n  createInteractionListeners() {\n    // blur event capture\n    window.addEventListener(\"blur\", () => {\n      const data = {\n        event: \"blur\",\n        trial: this.jsPsych.getProgress().current_trial_global,\n        time: this.jsPsych.getTotalTime(),\n      };\n      this.interactionData.push(data);\n      this.jsPsych.getInitSettings().on_interaction_data_update(data);\n    });\n\n    // focus event capture\n    window.addEventListener(\"focus\", () => {\n      const data = {\n        event: \"focus\",\n        trial: this.jsPsych.getProgress().current_trial_global,\n        time: this.jsPsych.getTotalTime(),\n      };\n      this.interactionData.push(data);\n      this.jsPsych.getInitSettings().on_interaction_data_update(data);\n    });\n\n    // fullscreen change capture\n    const fullscreenchange = () => {\n      const data = {\n        event:\n          // @ts-expect-error\n          document.isFullScreen ||\n          // @ts-expect-error\n          document.webkitIsFullScreen ||\n          // @ts-expect-error\n          document.mozIsFullScreen ||\n          document.fullscreenElement\n            ? \"fullscreenenter\"\n            : \"fullscreenexit\",\n        trial: this.jsPsych.getProgress().current_trial_global,\n        time: this.jsPsych.getTotalTime(),\n      };\n      this.interactionData.push(data);\n      this.jsPsych.getInitSettings().on_interaction_data_update(data);\n    };\n\n    document.addEventListener(\"fullscreenchange\", fullscreenchange);\n    document.addEventListener(\"mozfullscreenchange\", fullscreenchange);\n    document.addEventListener(\"webkitfullscreenchange\", fullscreenchange);\n  }\n\n  // public methods for testing purposes. not recommended for use.\n  _customInsert(data) {\n    this.allData = new DataCollection(data);\n  }\n\n  _fullreset() {\n    this.reset();\n    this.dataProperties = {};\n  }\n}\n","export class HardwareAPI {\n  /**\n   * Indicates whether this instance of jspsych has opened a hardware connection through our browser\n   * extension\n   **/\n  hardwareConnected = false;\n\n  constructor() {\n    //it might be useful to open up a line of communication from the extension back to this page\n    //script, again, this will have to pass through DOM events. For now speed is of no concern so I\n    //will use jQuery\n    document.addEventListener(\"jspsych-activate\", (evt) => {\n      this.hardwareConnected = true;\n    });\n  }\n\n  /**\n   * Allows communication with user hardware through our custom Google Chrome extension + native C++ program\n   * @param\t\tmess\tThe message to be passed to our extension, see its documentation for the expected members of this object.\n   * @author\tDaniel Rivas\n   *\n   */\n  hardware(mess) {\n    //since Chrome extension content-scripts do not share the javascript environment with the page\n    //script that loaded jspsych, we will need to use hacky methods like communicating through DOM\n    //events.\n    const jspsychEvt = new CustomEvent(\"jspsych\", { detail: mess });\n    document.dispatchEvent(jspsychEvt);\n    //And voila! it will be the job of the content script injected by the extension to listen for\n    //the event and do the appropriate actions.\n  }\n}\n","import autoBind from \"auto-bind\";\n\nexport type KeyboardListener = (e: KeyboardEvent) => void;\n\nexport type ValidResponses = string[] | \"ALL_KEYS\" | \"NO_KEYS\";\n\nexport interface GetKeyboardResponseOptions {\n  callback_function: any;\n  valid_responses?: ValidResponses;\n  rt_method?: \"performance\" | \"audio\";\n  persist?: boolean;\n  audio_context?: AudioContext;\n  audio_context_start_time?: number;\n  allow_held_key?: boolean;\n  minimum_valid_rt?: number;\n}\n\nexport class KeyboardListenerAPI {\n  constructor(\n    private getRootElement: () => Element | undefined,\n    private areResponsesCaseSensitive: boolean = false,\n    private minimumValidRt = 0\n  ) {\n    autoBind(this);\n    this.registerRootListeners();\n  }\n\n  private listeners = new Set<KeyboardListener>();\n  private heldKeys = new Set<string>();\n\n  private areRootListenersRegistered = false;\n\n  /**\n   * If not previously done and `this.getRootElement()` returns an element, adds the root key\n   * listeners to that element.\n   */\n  private registerRootListeners() {\n    if (!this.areRootListenersRegistered) {\n      const rootElement = this.getRootElement();\n      if (rootElement) {\n        rootElement.addEventListener(\"keydown\", this.rootKeydownListener);\n        rootElement.addEventListener(\"keyup\", this.rootKeyupListener);\n        this.areRootListenersRegistered = true;\n      }\n    }\n  }\n\n  private rootKeydownListener(e: KeyboardEvent) {\n    // Iterate over a static copy of the listeners set because listeners might add other listeners\n    // that we do not want to be included in the loop\n    for (const listener of Array.from(this.listeners)) {\n      listener(e);\n    }\n    this.heldKeys.add(this.toLowerCaseIfInsensitive(e.key));\n  }\n\n  private toLowerCaseIfInsensitive(string: string) {\n    return this.areResponsesCaseSensitive ? string : string.toLowerCase();\n  }\n\n  private rootKeyupListener(e: KeyboardEvent) {\n    this.heldKeys.delete(this.toLowerCaseIfInsensitive(e.key));\n  }\n\n  private isResponseValid(validResponses: ValidResponses, allowHeldKey: boolean, key: string) {\n    // check if key was already held down\n    if (!allowHeldKey && this.heldKeys.has(key)) {\n      return false;\n    }\n\n    if (validResponses === \"ALL_KEYS\") {\n      return true;\n    }\n    if (validResponses === \"NO_KEYS\") {\n      return false;\n    }\n\n    return validResponses.includes(key);\n  }\n\n  getKeyboardResponse({\n    callback_function,\n    valid_responses = \"ALL_KEYS\",\n    rt_method = \"performance\",\n    persist,\n    audio_context,\n    audio_context_start_time,\n    allow_held_key = false,\n    minimum_valid_rt = this.minimumValidRt,\n  }: GetKeyboardResponseOptions) {\n    if (rt_method !== \"performance\" && rt_method !== \"audio\") {\n      console.log(\n        'Invalid RT method specified in getKeyboardResponse. Defaulting to \"performance\" method.'\n      );\n      rt_method = \"performance\";\n    }\n\n    const usePerformanceRt = rt_method === \"performance\";\n    const startTime = usePerformanceRt ? performance.now() : audio_context_start_time * 1000;\n\n    this.registerRootListeners();\n\n    if (!this.areResponsesCaseSensitive && typeof valid_responses !== \"string\") {\n      valid_responses = valid_responses.map((r) => r.toLowerCase());\n    }\n\n    const listener: KeyboardListener = (e) => {\n      const rt = Math.round(\n        (rt_method == \"performance\" ? performance.now() : audio_context.currentTime * 1000) -\n          startTime\n      );\n      if (rt < minimum_valid_rt) {\n        return;\n      }\n\n      const key = this.toLowerCaseIfInsensitive(e.key);\n\n      if (this.isResponseValid(valid_responses, allow_held_key, key)) {\n        // if this is a valid response, then we don't want the key event to trigger other actions\n        // like scrolling via the spacebar.\n        e.preventDefault();\n\n        if (!persist) {\n          // remove keyboard listener if it exists\n          this.cancelKeyboardResponse(listener);\n        }\n\n        callback_function({ key, rt });\n      }\n    };\n\n    this.listeners.add(listener);\n    return listener;\n  }\n\n  cancelKeyboardResponse(listener: KeyboardListener) {\n    // remove the listener from the set of listeners if it is contained\n    this.listeners.delete(listener);\n  }\n\n  cancelAllKeyboardResponses() {\n    this.listeners.clear();\n  }\n\n  compareKeys(key1: string | null, key2: string | null) {\n    if (\n      (typeof key1 !== \"string\" && key1 !== null) ||\n      (typeof key2 !== \"string\" && key2 !== null)\n    ) {\n      console.error(\n        \"Error in jsPsych.pluginAPI.compareKeys: arguments must be key strings or null.\"\n      );\n      return undefined;\n    }\n\n    if (typeof key1 === \"string\" && typeof key2 === \"string\") {\n      // if both values are strings, then check whether or not letter case should be converted before comparing (case_sensitive_responses in initJsPsych)\n      return this.areResponsesCaseSensitive\n        ? key1 === key2\n        : key1.toLowerCase() === key2.toLowerCase();\n    }\n\n    return key1 === null && key2 === null;\n  }\n}\n","import { ParameterType } from \"../../modules/plugins\";\nimport { unique } from \"../utils\";\n\nconst preloadParameterTypes = <const>[\n  ParameterType.AUDIO,\n  ParameterType.IMAGE,\n  ParameterType.VIDEO,\n];\ntype PreloadType = typeof preloadParameterTypes[number];\n\nexport class MediaAPI {\n  constructor(private useWebaudio: boolean, private webaudioContext?: AudioContext) {}\n\n  // video //\n  private video_buffers = {};\n  getVideoBuffer(videoID) {\n    return this.video_buffers[videoID];\n  }\n\n  // audio //\n  private context = null;\n  private audio_buffers = [];\n\n  initAudio() {\n    this.context = this.useWebaudio ? this.webaudioContext : null;\n  }\n\n  audioContext() {\n    if (this.context !== null) {\n      if (this.context.state !== \"running\") {\n        this.context.resume();\n      }\n    }\n    return this.context;\n  }\n\n  getAudioBuffer(audioID) {\n    return new Promise((resolve, reject) => {\n      // check whether audio file already preloaded\n      if (\n        typeof this.audio_buffers[audioID] == \"undefined\" ||\n        this.audio_buffers[audioID] == \"tmp\"\n      ) {\n        // if audio is not already loaded, try to load it\n        this.preloadAudio(\n          [audioID],\n          () => {\n            resolve(this.audio_buffers[audioID]);\n          },\n          () => {},\n          (e) => {\n            reject(e.error);\n          }\n        );\n      } else {\n        // audio is already loaded\n        resolve(this.audio_buffers[audioID]);\n      }\n    });\n  }\n\n  // preloading stimuli //\n  private preload_requests = [];\n\n  private img_cache = {};\n\n  preloadAudio(\n    files,\n    callback_complete = () => {},\n    callback_load = (filepath) => {},\n    callback_error = (error_msg) => {}\n  ) {\n    files = unique(files.flat());\n\n    let n_loaded = 0;\n\n    if (files.length == 0) {\n      callback_complete();\n      return;\n    }\n\n    const load_audio_file_webaudio = (source, count = 1) => {\n      const request = new XMLHttpRequest();\n      request.open(\"GET\", source, true);\n      request.responseType = \"arraybuffer\";\n      request.onload = () => {\n        this.context.decodeAudioData(\n          request.response,\n          (buffer) => {\n            this.audio_buffers[source] = buffer;\n            n_loaded++;\n            callback_load(source);\n            if (n_loaded == files.length) {\n              callback_complete();\n            }\n          },\n          (e) => {\n            callback_error({ source: source, error: e });\n          }\n        );\n      };\n      request.onerror = function (e) {\n        let err: ProgressEvent | string = e;\n        if (this.status == 404) {\n          err = \"404\";\n        }\n        callback_error({ source: source, error: err });\n      };\n      request.onloadend = function (e) {\n        if (this.status == 404) {\n          callback_error({ source: source, error: \"404\" });\n        }\n      };\n      request.send();\n      this.preload_requests.push(request);\n    };\n\n    const load_audio_file_html5audio = (source, count = 1) => {\n      const audio = new Audio();\n      const handleCanPlayThrough = () => {\n        this.audio_buffers[source] = audio;\n        n_loaded++;\n        callback_load(source);\n        if (n_loaded == files.length) {\n          callback_complete();\n        }\n        audio.removeEventListener(\"canplaythrough\", handleCanPlayThrough);\n      };\n      audio.addEventListener(\"canplaythrough\", handleCanPlayThrough);\n      audio.addEventListener(\"error\", function handleError(e) {\n        callback_error({ source: audio.src, error: e });\n        audio.removeEventListener(\"error\", handleError);\n      });\n      audio.addEventListener(\"abort\", function handleAbort(e) {\n        callback_error({ source: audio.src, error: e });\n        audio.removeEventListener(\"abort\", handleAbort);\n      });\n      audio.src = source;\n      this.preload_requests.push(audio);\n    };\n\n    for (const file of files) {\n      if (typeof this.audio_buffers[file] !== \"undefined\") {\n        n_loaded++;\n        callback_load(file);\n        if (n_loaded == files.length) {\n          callback_complete();\n        }\n      } else {\n        this.audio_buffers[file] = \"tmp\";\n        if (this.audioContext() !== null) {\n          load_audio_file_webaudio(file);\n        } else {\n          load_audio_file_html5audio(file);\n        }\n      }\n    }\n  }\n\n  preloadImages(\n    images,\n    callback_complete = () => {},\n    callback_load = (filepath) => {},\n    callback_error = (error_msg) => {}\n  ) {\n    // flatten the images array\n    images = unique(images.flat());\n\n    var n_loaded = 0;\n\n    if (images.length === 0) {\n      callback_complete();\n      return;\n    }\n\n    for (var i = 0; i < images.length; i++) {\n      var img = new Image();\n\n      img.onload = function () {\n        n_loaded++;\n        callback_load(img.src);\n        if (n_loaded === images.length) {\n          callback_complete();\n        }\n      };\n\n      img.onerror = function (e) {\n        callback_error({ source: img.src, error: e });\n      };\n\n      img.src = images[i];\n\n      this.img_cache[images[i]] = img;\n      this.preload_requests.push(img);\n    }\n  }\n\n  preloadVideo(\n    videos,\n    callback_complete = () => {},\n    callback_load = (filepath) => {},\n    callback_error = (error_msg) => {}\n  ) {\n    // flatten the video array\n    videos = unique(videos.flat());\n\n    let n_loaded = 0;\n\n    if (videos.length === 0) {\n      callback_complete();\n      return;\n    }\n\n    for (const video of videos) {\n      const video_buffers = this.video_buffers;\n\n      //based on option 4 here: http://dinbror.dk/blog/how-to-preload-entire-html5-video-before-play-solved/\n      const request = new XMLHttpRequest();\n      request.open(\"GET\", video, true);\n      request.responseType = \"blob\";\n      request.onload = function () {\n        if (this.status === 200 || this.status === 0) {\n          const videoBlob = this.response;\n          video_buffers[video] = URL.createObjectURL(videoBlob); // IE10+\n          n_loaded++;\n          callback_load(video);\n          if (n_loaded === videos.length) {\n            callback_complete();\n          }\n        }\n      };\n      request.onerror = function (e) {\n        let err: ProgressEvent | string = e;\n        if (this.status == 404) {\n          err = \"404\";\n        }\n        callback_error({ source: video, error: err });\n      };\n      request.onloadend = function (e) {\n        if (this.status == 404) {\n          callback_error({ source: video, error: \"404\" });\n        }\n      };\n      request.send();\n      this.preload_requests.push(request);\n    }\n  }\n\n  private preloadMap = new Map<string, Record<string, PreloadType>>();\n\n  getAutoPreloadList(timeline_description: any[]) {\n    /** Map each preload parameter type to a set of paths to be preloaded */\n    const preloadPaths = Object.fromEntries(\n      preloadParameterTypes.map((type) => [type, new Set<string>()])\n    );\n\n    const traverseTimeline = (node, inheritedTrialType?) => {\n      const isTimeline = typeof node.timeline !== \"undefined\";\n\n      if (isTimeline) {\n        for (const childNode of node.timeline) {\n          traverseTimeline(childNode, node.type ?? inheritedTrialType);\n        }\n      } else if ((node.type ?? inheritedTrialType)?.info) {\n        // node is a trial with type.info set\n\n        // Get the plugin name and parameters object from the info object\n        const { name: pluginName, parameters } = (node.type ?? inheritedTrialType).info;\n\n        // Extract parameters to be preloaded and their types from parameter info if this has not\n        // yet been done for `pluginName`\n        if (!this.preloadMap.has(pluginName)) {\n          this.preloadMap.set(\n            pluginName,\n            Object.fromEntries(\n              Object.entries<any>(parameters)\n                // Filter out parameter entries with media types and a non-false `preload` option\n                .filter(\n                  ([_name, { type, preload }]) =>\n                    preloadParameterTypes.includes(type) && (preload ?? true)\n                )\n                // Map each entry's value to its parameter type\n                .map(([name, { type }]) => [name, type])\n            )\n          );\n        }\n\n        // Add preload paths from this trial\n        for (const [parameterName, parameterType] of Object.entries(\n          this.preloadMap.get(pluginName)\n        )) {\n          const parameterValue = node[parameterName];\n          const elements = preloadPaths[parameterType];\n\n          if (typeof parameterValue === \"string\") {\n            elements.add(parameterValue);\n          } else if (Array.isArray(parameterValue)) {\n            for (const element of parameterValue.flat()) {\n              if (typeof element === \"string\") {\n                elements.add(element);\n              }\n            }\n          }\n        }\n      }\n    };\n\n    traverseTimeline({ timeline: timeline_description });\n\n    return {\n      images: [...preloadPaths[ParameterType.IMAGE]],\n      audio: [...preloadPaths[ParameterType.AUDIO]],\n      video: [...preloadPaths[ParameterType.VIDEO]],\n    };\n  }\n\n  cancelPreloads() {\n    for (const request of this.preload_requests) {\n      request.onload = () => {};\n      request.onerror = () => {};\n      request.oncanplaythrough = () => {};\n      request.onabort = () => {};\n    }\n    this.preload_requests = [];\n  }\n}\n","export class TimeoutAPI {\n  private timeout_handlers = [];\n\n  setTimeout(callback, delay) {\n    const handle = window.setTimeout(callback, delay);\n    this.timeout_handlers.push(handle);\n    return handle;\n  }\n\n  clearAllTimeouts() {\n    for (const handler of this.timeout_handlers) {\n      clearTimeout(handler);\n    }\n    this.timeout_handlers = [];\n  }\n}\n","export function repeat(array, repetitions, unpack = false) {\n  const arr_isArray = Array.isArray(array);\n  const rep_isArray = Array.isArray(repetitions);\n\n  // if array is not an array, then we just repeat the item\n  if (!arr_isArray) {\n    if (!rep_isArray) {\n      array = [array];\n      repetitions = [repetitions];\n    } else {\n      repetitions = [repetitions[0]];\n      console.log(\n        \"Unclear parameters given to randomization.repeat. Multiple set sizes specified, but only one item exists to sample. Proceeding using the first set size.\"\n      );\n    }\n  } else {\n    // if repetitions is not an array, but array is, then we\n    // repeat repetitions for each entry in array\n    if (!rep_isArray) {\n      let reps = [];\n      for (let i = 0; i < array.length; i++) {\n        reps.push(repetitions);\n      }\n      repetitions = reps;\n    } else {\n      if (array.length != repetitions.length) {\n        console.warn(\n          \"Unclear parameters given to randomization.repeat. Items and repetitions are unequal lengths. Behavior may not be as expected.\"\n        );\n        // throw warning if repetitions is too short, use first rep ONLY.\n        if (repetitions.length < array.length) {\n          let reps = [];\n          for (let i = 0; i < array.length; i++) {\n            reps.push(repetitions);\n          }\n          repetitions = reps;\n        } else {\n          // throw warning if too long, and then use the first N\n          repetitions = repetitions.slice(0, array.length);\n        }\n      }\n    }\n  }\n\n  // should be clear at this point to assume that array and repetitions are arrays with == length\n  let allsamples = [];\n  for (let i = 0; i < array.length; i++) {\n    for (let j = 0; j < repetitions[i]; j++) {\n      if (array[i] == null || typeof array[i] != \"object\") {\n        allsamples.push(array[i]);\n      } else {\n        allsamples.push(Object.assign({}, array[i]));\n      }\n    }\n  }\n\n  let out: any = shuffle(allsamples);\n\n  if (unpack) {\n    out = unpackArray(out);\n  }\n\n  return out;\n}\n\nexport function shuffle(array: Array<any>) {\n  if (!Array.isArray(array)) {\n    console.error(\"Argument to shuffle() must be an array.\");\n  }\n\n  const copy_array = array.slice(0);\n  let m = copy_array.length,\n    t,\n    i;\n\n  // While there remain elements to shuffle\n  while (m) {\n    // Pick a remaining element\n    i = Math.floor(Math.random() * m--);\n\n    // And swap it with the current element.\n    t = copy_array[m];\n    copy_array[m] = copy_array[i];\n    copy_array[i] = t;\n  }\n\n  return copy_array;\n}\n\nexport function shuffleNoRepeats(arr: Array<any>, equalityTest: (a: any, b: any) => boolean) {\n  if (!Array.isArray(arr)) {\n    console.error(\"First argument to shuffleNoRepeats() must be an array.\");\n  }\n  if (typeof equalityTest !== \"undefined\" && typeof equalityTest !== \"function\") {\n    console.error(\"Second argument to shuffleNoRepeats() must be a function.\");\n  }\n  // define a default equalityTest\n  if (typeof equalityTest == \"undefined\") {\n    equalityTest = function (a, b) {\n      if (a === b) {\n        return true;\n      } else {\n        return false;\n      }\n    };\n  }\n\n  const random_shuffle = shuffle(arr);\n  for (let i = 0; i < random_shuffle.length - 1; i++) {\n    if (equalityTest(random_shuffle[i], random_shuffle[i + 1])) {\n      // neighbors are equal, pick a new random neighbor to swap (not the first or last element, to avoid edge cases)\n      let random_pick = Math.floor(Math.random() * (random_shuffle.length - 2)) + 1;\n      // test to make sure the new neighbor isn't equal to the old one\n      while (\n        equalityTest(random_shuffle[i + 1], random_shuffle[random_pick]) ||\n        equalityTest(random_shuffle[i + 1], random_shuffle[random_pick + 1]) ||\n        equalityTest(random_shuffle[i + 1], random_shuffle[random_pick - 1])\n      ) {\n        random_pick = Math.floor(Math.random() * (random_shuffle.length - 2)) + 1;\n      }\n      const new_neighbor = random_shuffle[random_pick];\n      random_shuffle[random_pick] = random_shuffle[i + 1];\n      random_shuffle[i + 1] = new_neighbor;\n    }\n  }\n\n  return random_shuffle;\n}\n\nexport function shuffleAlternateGroups(arr_groups, random_group_order = false) {\n  const n_groups = arr_groups.length;\n  if (n_groups == 1) {\n    console.warn(\n      \"shuffleAlternateGroups() was called with only one group. Defaulting to simple shuffle.\"\n    );\n    return shuffle(arr_groups[0]);\n  }\n\n  let group_order = [];\n  for (let i = 0; i < n_groups; i++) {\n    group_order.push(i);\n  }\n  if (random_group_order) {\n    group_order = shuffle(group_order);\n  }\n\n  const randomized_groups = [];\n  let min_length = null;\n  for (let i = 0; i < n_groups; i++) {\n    min_length =\n      min_length === null ? arr_groups[i].length : Math.min(min_length, arr_groups[i].length);\n    randomized_groups.push(shuffle(arr_groups[i]));\n  }\n\n  const out = [];\n  for (let i = 0; i < min_length; i++) {\n    for (let j = 0; j < group_order.length; j++) {\n      out.push(randomized_groups[group_order[j]][i]);\n    }\n  }\n\n  return out;\n}\n\nexport function sampleWithoutReplacement(arr, size) {\n  if (!Array.isArray(arr)) {\n    console.error(\"First argument to sampleWithoutReplacement() must be an array\");\n  }\n\n  if (size > arr.length) {\n    console.error(\"Cannot take a sample larger than the size of the set of items to sample.\");\n  }\n  return shuffle(arr).slice(0, size);\n}\n\nexport function sampleWithReplacement(arr, size, weights) {\n  if (!Array.isArray(arr)) {\n    console.error(\"First argument to sampleWithReplacement() must be an array\");\n  }\n\n  const normalized_weights = [];\n  if (typeof weights !== \"undefined\") {\n    if (weights.length !== arr.length) {\n      console.error(\n        \"The length of the weights array must equal the length of the array \" +\n          \"to be sampled from.\"\n      );\n    }\n    let weight_sum = 0;\n    for (const weight of weights) {\n      weight_sum += weight;\n    }\n    for (const weight of weights) {\n      normalized_weights.push(weight / weight_sum);\n    }\n  } else {\n    for (let i = 0; i < arr.length; i++) {\n      normalized_weights.push(1 / arr.length);\n    }\n  }\n\n  const cumulative_weights = [normalized_weights[0]];\n  for (let i = 1; i < normalized_weights.length; i++) {\n    cumulative_weights.push(normalized_weights[i] + cumulative_weights[i - 1]);\n  }\n\n  const samp = [];\n  for (let i = 0; i < size; i++) {\n    const rnd = Math.random();\n    let index = 0;\n    while (rnd > cumulative_weights[index]) {\n      index++;\n    }\n    samp.push(arr[index]);\n  }\n  return samp;\n}\n\nexport function factorial(factors: Record<string, any>, repetitions = 1, unpack = false) {\n  let design = [{}];\n  for (const [factorName, factor] of Object.entries(factors)) {\n    const new_design = [];\n    for (const level of factor) {\n      for (const cell of design) {\n        new_design.push({ ...cell, [factorName]: level });\n      }\n    }\n    design = new_design;\n  }\n\n  return repeat(design, repetitions, unpack);\n}\n\nexport function randomID(length = 32) {\n  let result = \"\";\n  const chars = \"0123456789abcdefghjklmnopqrstuvwxyz\";\n  for (let i = 0; i < length; i++) {\n    result += chars[Math.floor(Math.random() * chars.length)];\n  }\n  return result;\n}\n\nfunction unpackArray(array) {\n  const out = {};\n\n  for (const x of array) {\n    for (const key of Object.keys(x)) {\n      if (typeof out[key] === \"undefined\") {\n        out[key] = [];\n      }\n      out[key].push(x[key]);\n    }\n  }\n\n  return out;\n}\n","interface turkInformation {\n  /**\n   * Is the experiment being loaded in preview mode on Mechanical Turk?\n   */\n  previewMode: boolean;\n  /**\n   * Is the experiment being loaded outside of the Mechanical Turk environment?\n   */\n  outsideTurk: boolean;\n  /**\n   * The HIT ID.\n   */\n  hitId: string;\n  /**\n   * The Assignment ID.\n   */\n  assignmentId: string;\n  /**\n   * The worker ID.\n   */\n  workerId: string;\n  /**\n   * URL for submission of the HIT.\n   */\n  turkSubmitTo: string;\n}\n\n/**\n * Gets information about the Mechanical Turk Environment, HIT, Assignment, and Worker\n * by parsing the URL variables that Mechanical Turk generates.\n * @returns An object containing information about the Mechanical Turk Environment, HIT, Assignment, and Worker.\n */\nexport function turkInfo(): turkInformation {\n  const turk: turkInformation = {\n    previewMode: false,\n    outsideTurk: false,\n    hitId: \"INVALID_URL_PARAMETER\",\n    assignmentId: \"INVALID_URL_PARAMETER\",\n    workerId: \"INVALID_URL_PARAMETER\",\n    turkSubmitTo: \"INVALID_URL_PARAMETER\",\n  };\n\n  const param = function (url, name) {\n    name = name.replace(/[\\[]/, \"\\\\[\").replace(/[\\]]/, \"\\\\]\");\n    const regexS = \"[\\\\?&]\" + name + \"=([^&#]*)\";\n    const regex = new RegExp(regexS);\n    const results = regex.exec(url);\n    return results == null ? \"\" : results[1];\n  };\n\n  const src = param(window.location.href, \"assignmentId\")\n    ? window.location.href\n    : document.referrer;\n\n  const keys = [\"assignmentId\", \"hitId\", \"workerId\", \"turkSubmitTo\"];\n  keys.map(function (key) {\n    turk[key] = unescape(param(src, key));\n  });\n\n  turk.previewMode = turk.assignmentId == \"ASSIGNMENT_ID_NOT_AVAILABLE\";\n\n  turk.outsideTurk =\n    !turk.previewMode && turk.hitId === \"\" && turk.assignmentId == \"\" && turk.workerId == \"\";\n\n  return turk;\n}\n\n/**\n * Send data to Mechnical Turk for storage.\n * @param data An object containing `key:value` pairs to send to Mechanical Turk. Values\n * cannot contain nested objects, arrays, or functions.\n * @returns Nothing\n */\nexport function submitToTurk(data) {\n  const turk = turkInfo();\n  const assignmentId = turk.assignmentId;\n  const turkSubmitTo = turk.turkSubmitTo;\n\n  if (!assignmentId || !turkSubmitTo) return;\n\n  const form = document.createElement(\"form\");\n  form.method = \"POST\";\n  form.action = turkSubmitTo + \"/mturk/externalSubmit?assignmentId=\" + assignmentId;\n\n  for (const key in data) {\n    if (data.hasOwnProperty(key)) {\n      const hiddenField = document.createElement(\"input\");\n      hiddenField.type = \"hidden\";\n      hiddenField.name = key;\n      hiddenField.id = key;\n      hiddenField.value = data[key];\n\n      form.appendChild(hiddenField);\n    }\n  }\n\n  document.body.appendChild(form);\n  form.submit();\n}\n","import { JsPsych } from \"./JsPsych\";\nimport {\n  repeat,\n  sampleWithReplacement,\n  sampleWithoutReplacement,\n  shuffle,\n  shuffleAlternateGroups,\n} from \"./modules/randomization\";\nimport { deepCopy } from \"./modules/utils\";\n\nexport class TimelineNode {\n  // a unique ID for this node, relative to the parent\n  relative_id;\n\n  // store the parent for this node\n  parent_node;\n\n  // parameters for the trial if the node contains a trial\n  trial_parameters;\n\n  // parameters for nodes that contain timelines\n  timeline_parameters;\n\n  // stores trial information on a node that contains a timeline\n  // used for adding new trials\n  node_trial_data;\n\n  // track progress through the node\n  progress = <any>{\n    current_location: -1, // where on the timeline (which timelinenode)\n    current_variable_set: 0, // which set of variables to use from timeline_variables\n    current_repetition: 0, // how many times through the variable set on this run of the node\n    current_iteration: 0, // how many times this node has been revisited\n    done: false,\n  };\n\n  end_message?: string;\n\n  // constructor\n  constructor(private jsPsych: JsPsych, parameters, parent?, relativeID?) {\n    // store a link to the parent of this node\n    this.parent_node = parent;\n\n    // create the ID for this node\n    this.relative_id = typeof parent === \"undefined\" ? 0 : relativeID;\n\n    // check if there is a timeline parameter\n    // if there is, then this node has its own timeline\n    if (typeof parameters.timeline !== \"undefined\") {\n      // create timeline properties\n      this.timeline_parameters = {\n        timeline: [],\n        loop_function: parameters.loop_function,\n        conditional_function: parameters.conditional_function,\n        sample: parameters.sample,\n        randomize_order:\n          typeof parameters.randomize_order == \"undefined\" ? false : parameters.randomize_order,\n        repetitions: typeof parameters.repetitions == \"undefined\" ? 1 : parameters.repetitions,\n        timeline_variables:\n          typeof parameters.timeline_variables == \"undefined\"\n            ? [{}]\n            : parameters.timeline_variables,\n        on_timeline_finish: parameters.on_timeline_finish,\n        on_timeline_start: parameters.on_timeline_start,\n      };\n\n      this.setTimelineVariablesOrder();\n\n      // extract all of the node level data and parameters\n      // but remove all of the timeline-level specific information\n      // since this will be used to copy things down hierarchically\n      var node_data = Object.assign({}, parameters);\n      delete node_data.timeline;\n      delete node_data.conditional_function;\n      delete node_data.loop_function;\n      delete node_data.randomize_order;\n      delete node_data.repetitions;\n      delete node_data.timeline_variables;\n      delete node_data.sample;\n      delete node_data.on_timeline_start;\n      delete node_data.on_timeline_finish;\n      this.node_trial_data = node_data; // store for later...\n\n      // create a TimelineNode for each element in the timeline\n      for (var i = 0; i < parameters.timeline.length; i++) {\n        // merge parameters\n        var merged_parameters = Object.assign({}, node_data, parameters.timeline[i]);\n        // merge any data from the parent node into child nodes\n        if (typeof node_data.data == \"object\" && typeof parameters.timeline[i].data == \"object\") {\n          var merged_data = Object.assign({}, node_data.data, parameters.timeline[i].data);\n          merged_parameters.data = merged_data;\n        }\n        this.timeline_parameters.timeline.push(\n          new TimelineNode(this.jsPsych, merged_parameters, this, i)\n        );\n      }\n    }\n    // if there is no timeline parameter, then this node is a trial node\n    else {\n      // check to see if a valid trial type is defined\n      if (typeof parameters.type === \"undefined\") {\n        console.error(\n          'Trial level node is missing the \"type\" parameter. The parameters for the node are: ' +\n            JSON.stringify(parameters)\n        );\n      }\n      // create a deep copy of the parameters for the trial\n      this.trial_parameters = { ...parameters };\n    }\n  }\n\n  // recursively get the next trial to run.\n  // if this node is a leaf (trial), then return the trial.\n  // otherwise, recursively find the next trial in the child timeline.\n  trial() {\n    if (typeof this.timeline_parameters == \"undefined\") {\n      // returns a clone of the trial_parameters to\n      // protect functions.\n      return deepCopy(this.trial_parameters);\n    } else {\n      if (this.progress.current_location >= this.timeline_parameters.timeline.length) {\n        return null;\n      } else {\n        return this.timeline_parameters.timeline[this.progress.current_location].trial();\n      }\n    }\n  }\n\n  markCurrentTrialComplete() {\n    if (typeof this.timeline_parameters === \"undefined\") {\n      this.progress.done = true;\n    } else {\n      this.timeline_parameters.timeline[this.progress.current_location].markCurrentTrialComplete();\n    }\n  }\n\n  nextRepetiton() {\n    this.setTimelineVariablesOrder();\n    this.progress.current_location = -1;\n    this.progress.current_variable_set = 0;\n    this.progress.current_repetition++;\n    for (var i = 0; i < this.timeline_parameters.timeline.length; i++) {\n      this.timeline_parameters.timeline[i].reset();\n    }\n  }\n\n  // set the order for going through the timeline variables array\n  setTimelineVariablesOrder() {\n    const timeline_parameters = this.timeline_parameters;\n\n    // check to make sure this node has variables\n    if (\n      typeof timeline_parameters === \"undefined\" ||\n      typeof timeline_parameters.timeline_variables === \"undefined\"\n    ) {\n      return;\n    }\n\n    var order = [];\n    for (var i = 0; i < timeline_parameters.timeline_variables.length; i++) {\n      order.push(i);\n    }\n\n    if (typeof timeline_parameters.sample !== \"undefined\") {\n      if (timeline_parameters.sample.type == \"custom\") {\n        order = timeline_parameters.sample.fn(order);\n      } else if (timeline_parameters.sample.type == \"with-replacement\") {\n        order = sampleWithReplacement(\n          order,\n          timeline_parameters.sample.size,\n          timeline_parameters.sample.weights\n        );\n      } else if (timeline_parameters.sample.type == \"without-replacement\") {\n        order = sampleWithoutReplacement(order, timeline_parameters.sample.size);\n      } else if (timeline_parameters.sample.type == \"fixed-repetitions\") {\n        order = repeat(order, timeline_parameters.sample.size, false);\n      } else if (timeline_parameters.sample.type == \"alternate-groups\") {\n        order = shuffleAlternateGroups(\n          timeline_parameters.sample.groups,\n          timeline_parameters.sample.randomize_group_order\n        );\n      } else {\n        console.error(\n          'Invalid type in timeline sample parameters. Valid options for type are \"custom\", \"with-replacement\", \"without-replacement\", \"fixed-repetitions\", and \"alternate-groups\"'\n        );\n      }\n    }\n\n    if (timeline_parameters.randomize_order) {\n      order = shuffle(order);\n    }\n\n    this.progress.order = order;\n  }\n\n  // next variable set\n  nextSet() {\n    this.progress.current_location = -1;\n    this.progress.current_variable_set++;\n    for (var i = 0; i < this.timeline_parameters.timeline.length; i++) {\n      this.timeline_parameters.timeline[i].reset();\n    }\n  }\n\n  // update the current trial node to be completed\n  // returns true if the node is complete after advance (all subnodes are also complete)\n  // returns false otherwise\n  advance() {\n    const progress = this.progress;\n    const timeline_parameters = this.timeline_parameters;\n    const internal = this.jsPsych.internal;\n\n    // first check to see if done\n    if (progress.done) {\n      return true;\n    }\n\n    // if node has not started yet (progress.current_location == -1),\n    // then try to start the node.\n    if (progress.current_location == -1) {\n      // check for on_timeline_start and conditonal function on nodes with timelines\n      if (typeof timeline_parameters !== \"undefined\") {\n        // only run the conditional function if this is the first repetition of the timeline when\n        // repetitions > 1, and only when on the first variable set\n        if (\n          typeof timeline_parameters.conditional_function !== \"undefined\" &&\n          progress.current_repetition == 0 &&\n          progress.current_variable_set == 0\n        ) {\n          internal.call_immediate = true;\n          var conditional_result = timeline_parameters.conditional_function();\n          internal.call_immediate = false;\n          // if the conditional_function() returns false, then the timeline\n          // doesn't run and is marked as complete.\n          if (conditional_result == false) {\n            progress.done = true;\n            return true;\n          }\n        }\n\n        // if we reach this point then the node has its own timeline and will start\n        // so we need to check if there is an on_timeline_start function if we are on the first variable set\n        if (\n          typeof timeline_parameters.on_timeline_start !== \"undefined\" &&\n          progress.current_variable_set == 0\n        ) {\n          timeline_parameters.on_timeline_start();\n        }\n      }\n      // if we reach this point, then either the node doesn't have a timeline of the\n      // conditional function returned true and it can start\n      progress.current_location = 0;\n      // call advance again on this node now that it is pointing to a new location\n      return this.advance();\n    }\n\n    // if this node has a timeline, propogate down to the current trial.\n    if (typeof timeline_parameters !== \"undefined\") {\n      var have_node_to_run = false;\n      // keep incrementing the location in the timeline until one of the nodes reached is incomplete\n      while (\n        progress.current_location < timeline_parameters.timeline.length &&\n        have_node_to_run == false\n      ) {\n        // check to see if the node currently pointed at is done\n        var target_complete = timeline_parameters.timeline[progress.current_location].advance();\n        if (!target_complete) {\n          have_node_to_run = true;\n          return false;\n        } else {\n          progress.current_location++;\n        }\n      }\n\n      // if we've reached the end of the timeline (which, if the code is here, we have)\n\n      // there are a few steps to see what to do next...\n\n      // first, check the timeline_variables to see if we need to loop through again\n      // with a new set of variables\n      if (progress.current_variable_set < progress.order.length - 1) {\n        // reset the progress of the node to be with the new set\n        this.nextSet();\n        // then try to advance this node again.\n        return this.advance();\n      }\n\n      // if we're all done with the timeline_variables, then check to see if there are more repetitions\n      else if (progress.current_repetition < timeline_parameters.repetitions - 1) {\n        this.nextRepetiton();\n        // check to see if there is an on_timeline_finish function\n        if (typeof timeline_parameters.on_timeline_finish !== \"undefined\") {\n          timeline_parameters.on_timeline_finish();\n        }\n        return this.advance();\n      }\n\n      // if we're all done with the repetitions...\n      else {\n        // check to see if there is an on_timeline_finish function\n        if (typeof timeline_parameters.on_timeline_finish !== \"undefined\") {\n          timeline_parameters.on_timeline_finish();\n        }\n\n        // if we're all done with the repetitions, check if there is a loop function.\n        if (typeof timeline_parameters.loop_function !== \"undefined\") {\n          internal.call_immediate = true;\n          if (timeline_parameters.loop_function(this.generatedData())) {\n            this.reset();\n            internal.call_immediate = false;\n            return this.parent_node.advance();\n          } else {\n            progress.done = true;\n            internal.call_immediate = false;\n            return true;\n          }\n        }\n      }\n\n      // no more loops on this timeline, we're done!\n      progress.done = true;\n      return true;\n    }\n  }\n\n  // check the status of the done flag\n  isComplete() {\n    return this.progress.done;\n  }\n\n  // getter method for timeline variables\n  getTimelineVariableValue(variable_name: string) {\n    if (typeof this.timeline_parameters == \"undefined\") {\n      return undefined;\n    }\n    var v =\n      this.timeline_parameters.timeline_variables[\n        this.progress.order[this.progress.current_variable_set]\n      ][variable_name];\n    return v;\n  }\n\n  // recursive upward search for timeline variables\n  findTimelineVariable(variable_name) {\n    var v = this.getTimelineVariableValue(variable_name);\n    if (typeof v == \"undefined\") {\n      if (typeof this.parent_node !== \"undefined\") {\n        return this.parent_node.findTimelineVariable(variable_name);\n      } else {\n        return undefined;\n      }\n    } else {\n      return v;\n    }\n  }\n\n  // recursive downward search for active trial to extract timeline variable\n  timelineVariable(variable_name: string) {\n    if (typeof this.timeline_parameters == \"undefined\") {\n      return this.findTimelineVariable(variable_name);\n    } else {\n      // if progress.current_location is -1, then the timeline variable is being evaluated\n      // in a function that runs prior to the trial starting, so we should treat that trial\n      // as being the active trial for purposes of finding the value of the timeline variable\n      var loc = Math.max(0, this.progress.current_location);\n      // if loc is greater than the number of elements on this timeline, then the timeline\n      // variable is being evaluated in a function that runs after the trial on the timeline\n      // are complete but before advancing to the next (like a loop_function).\n      // treat the last active trial as the active trial for this purpose.\n      if (loc == this.timeline_parameters.timeline.length) {\n        loc = loc - 1;\n      }\n      // now find the variable\n      return this.timeline_parameters.timeline[loc].timelineVariable(variable_name);\n    }\n  }\n\n  // recursively get all the timeline variables for this trial\n  allTimelineVariables() {\n    var all_tvs = this.allTimelineVariablesNames();\n    var all_tvs_vals = <any>{};\n    for (var i = 0; i < all_tvs.length; i++) {\n      all_tvs_vals[all_tvs[i]] = this.timelineVariable(all_tvs[i]);\n    }\n    return all_tvs_vals;\n  }\n\n  // helper to get all the names at this stage.\n  allTimelineVariablesNames(so_far = []) {\n    if (typeof this.timeline_parameters !== \"undefined\") {\n      so_far = so_far.concat(\n        Object.keys(\n          this.timeline_parameters.timeline_variables[\n            this.progress.order[this.progress.current_variable_set]\n          ]\n        )\n      );\n      // if progress.current_location is -1, then the timeline variable is being evaluated\n      // in a function that runs prior to the trial starting, so we should treat that trial\n      // as being the active trial for purposes of finding the value of the timeline variable\n      var loc = Math.max(0, this.progress.current_location);\n      // if loc is greater than the number of elements on this timeline, then the timeline\n      // variable is being evaluated in a function that runs after the trial on the timeline\n      // are complete but before advancing to the next (like a loop_function).\n      // treat the last active trial as the active trial for this purpose.\n      if (loc == this.timeline_parameters.timeline.length) {\n        loc = loc - 1;\n      }\n      // now find the variable\n      return this.timeline_parameters.timeline[loc].allTimelineVariablesNames(so_far);\n    }\n    if (typeof this.timeline_parameters == \"undefined\") {\n      return so_far;\n    }\n  }\n\n  // recursively get the number of **trials** contained in the timeline\n  // assuming that while loops execute exactly once and if conditionals\n  // always run\n  length() {\n    var length = 0;\n    if (typeof this.timeline_parameters !== \"undefined\") {\n      for (var i = 0; i < this.timeline_parameters.timeline.length; i++) {\n        length += this.timeline_parameters.timeline[i].length();\n      }\n    } else {\n      return 1;\n    }\n    return length;\n  }\n\n  // return the percentage of trials completed, grouped at the first child level\n  // counts a set of trials as complete when the child node is done\n  percentComplete() {\n    var total_trials = this.length();\n    var completed_trials = 0;\n    for (var i = 0; i < this.timeline_parameters.timeline.length; i++) {\n      if (this.timeline_parameters.timeline[i].isComplete()) {\n        completed_trials += this.timeline_parameters.timeline[i].length();\n      }\n    }\n    return (completed_trials / total_trials) * 100;\n  }\n\n  // resets the node and all subnodes to original state\n  // but increments the current_iteration counter\n  reset() {\n    this.progress.current_location = -1;\n    this.progress.current_repetition = 0;\n    this.progress.current_variable_set = 0;\n    this.progress.current_iteration++;\n    this.progress.done = false;\n    this.setTimelineVariablesOrder();\n    if (typeof this.timeline_parameters != \"undefined\") {\n      for (var i = 0; i < this.timeline_parameters.timeline.length; i++) {\n        this.timeline_parameters.timeline[i].reset();\n      }\n    }\n  }\n\n  // mark this node as finished\n  end() {\n    this.progress.done = true;\n  }\n\n  // recursively end whatever sub-node is running the current trial\n  endActiveNode() {\n    if (typeof this.timeline_parameters == \"undefined\") {\n      this.end();\n      this.parent_node.end();\n    } else {\n      this.timeline_parameters.timeline[this.progress.current_location].endActiveNode();\n    }\n  }\n\n  // get a unique ID associated with this node\n  // the ID reflects the current iteration through this node.\n  ID() {\n    var id = \"\";\n    if (typeof this.parent_node == \"undefined\") {\n      return \"0.\" + this.progress.current_iteration;\n    } else {\n      id += this.parent_node.ID() + \"-\";\n      id += this.relative_id + \".\" + this.progress.current_iteration;\n      return id;\n    }\n  }\n\n  // get the ID of the active trial\n  activeID() {\n    if (typeof this.timeline_parameters == \"undefined\") {\n      return this.ID();\n    } else {\n      return this.timeline_parameters.timeline[this.progress.current_location].activeID();\n    }\n  }\n\n  // get all the data generated within this node\n  generatedData() {\n    return this.jsPsych.data.getDataByTimelineNode(this.ID());\n  }\n\n  // get all the trials of a particular type\n  trialsOfType(type) {\n    if (typeof this.timeline_parameters == \"undefined\") {\n      if (this.trial_parameters.type == type) {\n        return this.trial_parameters;\n      } else {\n        return [];\n      }\n    } else {\n      var trials = [];\n      for (var i = 0; i < this.timeline_parameters.timeline.length; i++) {\n        var t = this.timeline_parameters.timeline[i].trialsOfType(type);\n        trials = trials.concat(t);\n      }\n      return trials;\n    }\n  }\n\n  // add new trials to end of this timeline\n  insert(parameters) {\n    if (typeof this.timeline_parameters === \"undefined\") {\n      console.error(\"Cannot add new trials to a trial-level node.\");\n    } else {\n      this.timeline_parameters.timeline.push(\n        new TimelineNode(\n          this.jsPsych,\n          { ...this.node_trial_data, ...parameters },\n          this,\n          this.timeline_parameters.timeline.length\n        )\n      );\n    }\n  }\n}\n","import autoBind from \"auto-bind\";\n\nimport { version } from \"../package.json\";\nimport { JsPsychData } from \"./modules/data\";\nimport { PluginAPI, createJointPluginAPIObject } from \"./modules/plugin-api\";\nimport { ParameterType, universalPluginParameters } from \"./modules/plugins\";\nimport * as randomization from \"./modules/randomization\";\nimport * as turk from \"./modules/turk\";\nimport * as utils from \"./modules/utils\";\nimport { TimelineNode } from \"./TimelineNode\";\n\nfunction delay(ms: number) {\n  return new Promise((resolve) => setTimeout(resolve, ms));\n}\n\nexport class JsPsych {\n  extensions = <any>{};\n  turk = turk;\n  randomization = randomization;\n  utils = utils;\n  data: JsPsychData;\n  pluginAPI: PluginAPI;\n\n  version() {\n    return version;\n  }\n\n  //\n  // private variables\n  //\n\n  /**\n   * options\n   */\n  private opts: any = {};\n\n  /**\n   * experiment timeline\n   */\n  private timeline: TimelineNode;\n  private timelineDescription: any[];\n\n  // flow control\n  private global_trial_index = 0;\n  private current_trial: any = {};\n  private current_trial_finished = false;\n\n  // target DOM element\n  private DOM_container: HTMLElement;\n  private DOM_target: HTMLElement;\n\n  /**\n   * time that the experiment began\n   */\n  private exp_start_time;\n\n  /**\n   * is the experiment paused?\n   */\n  private paused = false;\n  private waiting = false;\n\n  /**\n   * is the page retrieved directly via file:// protocol (true) or hosted on a server (false)?\n   */\n  private file_protocol = false;\n\n  /**\n   * Promise that is resolved when `finishExperiment()` is called\n   */\n  private finished: Promise<void>;\n  private resolveFinishedPromise: () => void;\n\n  // storing a single webaudio context to prevent problems with multiple inits\n  // of jsPsych\n  webaudio_context: AudioContext = null;\n\n  internal = {\n    /**\n     * this flag is used to determine whether we are in a scope where\n     * jsPsych.timelineVariable() should be executed immediately or\n     * whether it should return a function to access the variable later.\n     *\n     **/\n    call_immediate: false,\n  };\n\n  constructor(options?) {\n    // override default options if user specifies an option\n    options = {\n      display_element: undefined,\n      on_finish: () => {},\n      on_trial_start: () => {},\n      on_trial_finish: () => {},\n      on_data_update: () => {},\n      on_interaction_data_update: () => {},\n      on_close: () => {},\n      use_webaudio: true,\n      exclusions: {},\n      show_progress_bar: false,\n      message_progress_bar: \"Completion Progress\",\n      auto_update_progress_bar: true,\n      default_iti: 0,\n      minimum_valid_rt: 0,\n      experiment_width: null,\n      override_safe_mode: false,\n      case_sensitive_responses: false,\n      extensions: [],\n      ...options,\n    };\n    this.opts = options;\n\n    autoBind(this); // so we can pass JsPsych methods as callbacks and `this` remains the JsPsych instance\n\n    this.webaudio_context =\n      typeof window !== \"undefined\" && typeof window.AudioContext !== \"undefined\"\n        ? new AudioContext()\n        : null;\n\n    // detect whether page is running in browser as a local file, and if so, disable web audio and video preloading to prevent CORS issues\n    if (\n      window.location.protocol == \"file:\" &&\n      (options.override_safe_mode === false || typeof options.override_safe_mode === \"undefined\")\n    ) {\n      options.use_webaudio = false;\n      this.file_protocol = true;\n      console.warn(\n        \"jsPsych detected that it is running via the file:// protocol and not on a web server. \" +\n          \"To prevent issues with cross-origin requests, Web Audio and video preloading have been disabled. \" +\n          \"If you would like to override this setting, you can set 'override_safe_mode' to 'true' in initJsPsych. \" +\n          \"For more information, see: https://www.jspsych.org/overview/running-experiments\"\n      );\n    }\n\n    // initialize modules\n    this.data = new JsPsychData(this);\n    this.pluginAPI = createJointPluginAPIObject(this);\n\n    // create instances of extensions\n    for (const extension of options.extensions) {\n      this.extensions[extension.type.info.name] = new extension.type(this);\n    }\n\n    // initialize audio context based on options and browser capabilities\n    this.pluginAPI.initAudio();\n  }\n\n  /**\n   * Starts an experiment using the provided timeline and returns a promise that is resolved when\n   * the experiment is finished.\n   *\n   * @param timeline The timeline to be run\n   */\n  async run(timeline: any[]) {\n    if (typeof timeline === \"undefined\") {\n      console.error(\"No timeline declared in jsPsych.run. Cannot start experiment.\");\n    }\n\n    if (timeline.length === 0) {\n      console.error(\n        \"No trials have been added to the timeline (the timeline is an empty array). Cannot start experiment.\"\n      );\n    }\n\n    // create experiment timeline\n    this.timelineDescription = timeline;\n    this.timeline = new TimelineNode(this, { timeline });\n\n    await this.prepareDom();\n    await this.checkExclusions(this.opts.exclusions);\n    await this.loadExtensions(this.opts.extensions);\n\n    document.documentElement.setAttribute(\"jspsych\", \"present\");\n\n    this.startExperiment();\n    await this.finished;\n  }\n\n  getProgress() {\n    return {\n      total_trials: typeof this.timeline === \"undefined\" ? undefined : this.timeline.length(),\n      current_trial_global: this.global_trial_index,\n      percent_complete: typeof this.timeline === \"undefined\" ? 0 : this.timeline.percentComplete(),\n    };\n  }\n\n  getStartTime() {\n    return this.exp_start_time;\n  }\n\n  getTotalTime() {\n    if (typeof this.exp_start_time === \"undefined\") {\n      return 0;\n    }\n    return new Date().getTime() - this.exp_start_time.getTime();\n  }\n\n  getDisplayElement() {\n    return this.DOM_target;\n  }\n\n  getDisplayContainerElement() {\n    return this.DOM_container;\n  }\n\n  finishTrial(data = {}) {\n    if (this.current_trial_finished) {\n      return;\n    }\n    this.current_trial_finished = true;\n\n    // remove any CSS classes that were added to the DOM via css_classes parameter\n    if (\n      typeof this.current_trial.css_classes !== \"undefined\" &&\n      Array.isArray(this.current_trial.css_classes)\n    ) {\n      this.DOM_target.classList.remove(...this.current_trial.css_classes);\n    }\n\n    // write the data from the trial\n    this.data.write(data);\n\n    // get back the data with all of the defaults in\n    const trial_data = this.data.get().filter({ trial_index: this.global_trial_index });\n\n    // for trial-level callbacks, we just want to pass in a reference to the values\n    // of the DataCollection, for easy access and editing.\n    const trial_data_values = trial_data.values()[0];\n\n    const current_trial = this.current_trial;\n\n    if (typeof current_trial.save_trial_parameters === \"object\") {\n      for (const key of Object.keys(current_trial.save_trial_parameters)) {\n        const key_val = current_trial.save_trial_parameters[key];\n        if (key_val === true) {\n          if (typeof current_trial[key] === \"undefined\") {\n            console.warn(\n              `Invalid parameter specified in save_trial_parameters. Trial has no property called \"${key}\".`\n            );\n          } else if (typeof current_trial[key] === \"function\") {\n            trial_data_values[key] = current_trial[key].toString();\n          } else {\n            trial_data_values[key] = current_trial[key];\n          }\n        }\n        if (key_val === false) {\n          // we don't allow internal_node_id or trial_index to be deleted because it would break other things\n          if (key !== \"internal_node_id\" && key !== \"trial_index\") {\n            delete trial_data_values[key];\n          }\n        }\n      }\n    }\n    // handle extension callbacks\n    if (Array.isArray(current_trial.extensions)) {\n      for (const extension of current_trial.extensions) {\n        const ext_data_values = this.extensions[extension.type.info.name].on_finish(\n          extension.params\n        );\n        Object.assign(trial_data_values, ext_data_values);\n      }\n    }\n\n    // about to execute lots of callbacks, so switch context.\n    this.internal.call_immediate = true;\n\n    // handle callback at plugin level\n    if (typeof current_trial.on_finish === \"function\") {\n      current_trial.on_finish(trial_data_values);\n    }\n\n    // handle callback at whole-experiment level\n    this.opts.on_trial_finish(trial_data_values);\n\n    // after the above callbacks are complete, then the data should be finalized\n    // for this trial. call the on_data_update handler, passing in the same\n    // data object that just went through the trial's finish handlers.\n    this.opts.on_data_update(trial_data_values);\n\n    // done with callbacks\n    this.internal.call_immediate = false;\n\n    // wait for iti\n    if (\n      typeof current_trial.post_trial_gap === null ||\n      typeof current_trial.post_trial_gap === \"undefined\"\n    ) {\n      if (this.opts.default_iti > 0) {\n        setTimeout(this.nextTrial, this.opts.default_iti);\n      } else {\n        this.nextTrial();\n      }\n    } else {\n      if (current_trial.post_trial_gap > 0) {\n        setTimeout(this.nextTrial, current_trial.post_trial_gap);\n      } else {\n        this.nextTrial();\n      }\n    }\n  }\n\n  endExperiment(end_message: string) {\n    this.timeline.end_message = end_message;\n    this.timeline.end();\n    this.pluginAPI.cancelAllKeyboardResponses();\n    this.pluginAPI.clearAllTimeouts();\n    this.finishTrial();\n  }\n\n  endCurrentTimeline() {\n    this.timeline.endActiveNode();\n  }\n\n  getCurrentTrial() {\n    return this.current_trial;\n  }\n\n  getInitSettings() {\n    return this.opts;\n  }\n\n  getCurrentTimelineNodeID() {\n    return this.timeline.activeID();\n  }\n\n  timelineVariable(varname: string, immediate = false) {\n    if (this.internal.call_immediate || immediate === true) {\n      return this.timeline.timelineVariable(varname);\n    } else {\n      return {\n        timelineVariablePlaceholder: true,\n        timelineVariableFunction: () => this.timeline.timelineVariable(varname),\n      };\n    }\n  }\n\n  getAllTimelineVariables() {\n    return this.timeline.allTimelineVariables();\n  }\n\n  addNodeToEndOfTimeline(new_timeline, preload_callback?) {\n    this.timeline.insert(new_timeline);\n  }\n\n  pauseExperiment() {\n    this.paused = true;\n  }\n\n  resumeExperiment() {\n    this.paused = false;\n    if (this.waiting) {\n      this.waiting = false;\n      this.nextTrial();\n    }\n  }\n\n  loadFail(message) {\n    message = message || \"<p>The experiment failed to load.</p>\";\n    this.DOM_target.innerHTML = message;\n  }\n\n  getSafeModeStatus() {\n    return this.file_protocol;\n  }\n\n  getTimeline() {\n    return this.timelineDescription;\n  }\n\n  private async prepareDom() {\n    // Wait until the document is ready\n    if (document.readyState !== \"complete\") {\n      await new Promise((resolve) => {\n        window.addEventListener(\"load\", resolve);\n      });\n    }\n\n    const options = this.opts;\n\n    // set DOM element where jsPsych will render content\n    // if undefined, then jsPsych will use the <body> tag and the entire page\n    if (typeof options.display_element === \"undefined\") {\n      // check if there is a body element on the page\n      const body = document.querySelector(\"body\");\n      if (body === null) {\n        document.documentElement.appendChild(document.createElement(\"body\"));\n      }\n      // using the full page, so we need the HTML element to\n      // have 100% height, and body to be full width and height with\n      // no margin\n      document.querySelector(\"html\").style.height = \"100%\";\n      document.querySelector(\"body\").style.margin = \"0px\";\n      document.querySelector(\"body\").style.height = \"100%\";\n      document.querySelector(\"body\").style.width = \"100%\";\n      options.display_element = document.querySelector(\"body\");\n    } else {\n      // make sure that the display element exists on the page\n      const display =\n        options.display_element instanceof Element\n          ? options.display_element\n          : document.querySelector(\"#\" + options.display_element);\n      if (display === null) {\n        console.error(\"The display_element specified in initJsPsych() does not exist in the DOM.\");\n      } else {\n        options.display_element = display;\n      }\n    }\n\n    options.display_element.innerHTML =\n      '<div class=\"jspsych-content-wrapper\"><div id=\"jspsych-content\"></div></div>';\n    this.DOM_container = options.display_element;\n    this.DOM_target = document.querySelector(\"#jspsych-content\");\n\n    // set experiment_width if not null\n    if (options.experiment_width !== null) {\n      this.DOM_target.style.width = options.experiment_width + \"px\";\n    }\n\n    // add tabIndex attribute to scope event listeners\n    options.display_element.tabIndex = 0;\n\n    // add CSS class to DOM_target\n    if (options.display_element.className.indexOf(\"jspsych-display-element\") === -1) {\n      options.display_element.className += \" jspsych-display-element\";\n    }\n    this.DOM_target.className += \"jspsych-content\";\n\n    // create listeners for user browser interaction\n    this.data.createInteractionListeners();\n\n    // add event for closing window\n    window.addEventListener(\"beforeunload\", options.on_close);\n  }\n\n  private async loadExtensions(extensions) {\n    // run the .initialize method of any extensions that are in use\n    // these should return a Promise to indicate when loading is complete\n\n    try {\n      await Promise.all(\n        extensions.map((extension) =>\n          this.extensions[extension.type.info.name].initialize(extension.params || {})\n        )\n      );\n    } catch (error_message) {\n      console.error(error_message);\n      throw new Error(error_message);\n    }\n  }\n\n  private startExperiment() {\n    this.finished = new Promise((resolve) => {\n      this.resolveFinishedPromise = resolve;\n    });\n\n    // show progress bar if requested\n    if (this.opts.show_progress_bar === true) {\n      this.drawProgressBar(this.opts.message_progress_bar);\n    }\n\n    // record the start time\n    this.exp_start_time = new Date();\n\n    // begin!\n    this.timeline.advance();\n    this.doTrial(this.timeline.trial());\n  }\n\n  private finishExperiment() {\n    const finish_result = this.opts.on_finish(this.data.get());\n\n    const done_handler = () => {\n      if (typeof this.timeline.end_message !== \"undefined\") {\n        this.DOM_target.innerHTML = this.timeline.end_message;\n      }\n      this.resolveFinishedPromise();\n    };\n\n    if (finish_result) {\n      Promise.resolve(finish_result).then(done_handler);\n    } else {\n      done_handler();\n    }\n  }\n\n  private nextTrial() {\n    // if experiment is paused, don't do anything.\n    if (this.paused) {\n      this.waiting = true;\n      return;\n    }\n\n    this.global_trial_index++;\n\n    // advance timeline\n    this.timeline.markCurrentTrialComplete();\n    const complete = this.timeline.advance();\n\n    // update progress bar if shown\n    if (this.opts.show_progress_bar === true && this.opts.auto_update_progress_bar === true) {\n      this.updateProgressBar();\n    }\n\n    // check if experiment is over\n    if (complete) {\n      this.finishExperiment();\n      return;\n    }\n\n    this.doTrial(this.timeline.trial());\n  }\n\n  private doTrial(trial) {\n    this.current_trial = trial;\n    this.current_trial_finished = false;\n\n    // process all timeline variables for this trial\n    this.evaluateTimelineVariables(trial);\n\n    // instantiate the plugin for this trial\n    trial.type = {\n      // this is a hack to internally keep the old plugin object structure and prevent touching more\n      // of the core jspsych code\n      ...autoBind(new trial.type(this)),\n      info: trial.type.info,\n    };\n\n    // evaluate variables that are functions\n    this.evaluateFunctionParameters(trial);\n\n    // get default values for parameters\n    this.setDefaultValues(trial);\n\n    // about to execute callbacks\n    this.internal.call_immediate = true;\n\n    // call experiment wide callback\n    this.opts.on_trial_start(trial);\n\n    // call trial specific callback if it exists\n    if (typeof trial.on_start === \"function\") {\n      trial.on_start(trial);\n    }\n\n    // call any on_start functions for extensions\n    if (Array.isArray(trial.extensions)) {\n      for (const extension of trial.extensions) {\n        this.extensions[extension.type.info.name].on_start(extension.params);\n      }\n    }\n\n    // apply the focus to the element containing the experiment.\n    this.DOM_container.focus();\n\n    // reset the scroll on the DOM target\n    this.DOM_target.scrollTop = 0;\n\n    // add CSS classes to the DOM_target if they exist in trial.css_classes\n    if (typeof trial.css_classes !== \"undefined\") {\n      if (!Array.isArray(trial.css_classes) && typeof trial.css_classes === \"string\") {\n        trial.css_classes = [trial.css_classes];\n      }\n      if (Array.isArray(trial.css_classes)) {\n        this.DOM_target.classList.add(...trial.css_classes);\n      }\n    }\n\n    // setup on_load event callback\n    const load_callback = () => {\n      if (typeof trial.on_load === \"function\") {\n        trial.on_load();\n      }\n\n      // call any on_load functions for extensions\n      if (Array.isArray(trial.extensions)) {\n        for (const extension of trial.extensions) {\n          this.extensions[extension.type.info.name].on_load(extension.params);\n        }\n      }\n    };\n\n    const trial_complete = trial.type.trial(this.DOM_target, trial, load_callback);\n    // see if trial_complete is a Promise by looking for .then() function\n    const is_promise = trial_complete && typeof trial_complete.then == \"function\";\n\n    if (!is_promise) {\n      load_callback();\n    }\n\n    // done with callbacks\n    this.internal.call_immediate = false;\n  }\n\n  private evaluateTimelineVariables(trial) {\n    for (const key of Object.keys(trial)) {\n      if (key === \"type\") {\n        // skip the `type` parameter as it contains a plugin\n        //continue;\n      }\n      // timeline variables on the root level\n      if (\n        typeof trial[key] === \"object\" &&\n        trial[key] !== null &&\n        typeof trial[key].timelineVariablePlaceholder !== \"undefined\"\n      ) {\n        /*trial[key].toString().replace(/\\s/g, \"\") ==\n          \"function(){returntimeline.timelineVariable(varname);}\"\n      )*/ trial[key] = trial[key].timelineVariableFunction();\n      }\n      // timeline variables that are nested in objects\n      if (typeof trial[key] === \"object\" && trial[key] !== null) {\n        this.evaluateTimelineVariables(trial[key]);\n      }\n    }\n  }\n\n  private evaluateFunctionParameters(trial) {\n    // set a flag so that jsPsych.timelineVariable() is immediately executed in this context\n    this.internal.call_immediate = true;\n\n    // iterate over each parameter\n    for (const key of Object.keys(trial)) {\n      // check to make sure parameter is not \"type\", since that was eval'd above.\n      if (key !== \"type\") {\n        // this if statement is checking to see if the parameter type is expected to be a function, in which case we should NOT evaluate it.\n        // the first line checks if the parameter is defined in the universalPluginParameters set\n        // the second line checks the plugin-specific parameters\n        if (\n          typeof universalPluginParameters[key] !== \"undefined\" &&\n          universalPluginParameters[key].type !== ParameterType.FUNCTION\n        ) {\n          trial[key] = this.replaceFunctionsWithValues(trial[key], null);\n        }\n        if (\n          typeof trial.type.info.parameters[key] !== \"undefined\" &&\n          trial.type.info.parameters[key].type !== ParameterType.FUNCTION\n        ) {\n          trial[key] = this.replaceFunctionsWithValues(trial[key], trial.type.info.parameters[key]);\n        }\n      }\n    }\n    // reset so jsPsych.timelineVariable() is no longer immediately executed\n    this.internal.call_immediate = false;\n  }\n\n  private replaceFunctionsWithValues(obj, info) {\n    // null typeof is 'object' (?!?!), so need to run this first!\n    if (obj === null) {\n      return obj;\n    }\n    // arrays\n    else if (Array.isArray(obj)) {\n      for (let i = 0; i < obj.length; i++) {\n        obj[i] = this.replaceFunctionsWithValues(obj[i], info);\n      }\n    }\n    // objects\n    else if (typeof obj === \"object\") {\n      if (info === null || !info.nested) {\n        for (const key of Object.keys(obj)) {\n          if (key === \"type\") {\n            // Ignore the object's `type` field because it contains a plugin and we do not want to\n            // call plugin functions\n            continue;\n          }\n          obj[key] = this.replaceFunctionsWithValues(obj[key], null);\n        }\n      } else {\n        for (const key of Object.keys(obj)) {\n          if (\n            typeof info.nested[key] === \"object\" &&\n            info.nested[key].type !== ParameterType.FUNCTION\n          ) {\n            obj[key] = this.replaceFunctionsWithValues(obj[key], info.nested[key]);\n          }\n        }\n      }\n    } else if (typeof obj === \"function\") {\n      return obj();\n    }\n    return obj;\n  }\n\n  private setDefaultValues(trial) {\n    for (const param in trial.type.info.parameters) {\n      // check if parameter is complex with nested defaults\n      if (trial.type.info.parameters[param].type === ParameterType.COMPLEX) {\n        if (trial.type.info.parameters[param].array === true) {\n          // iterate over each entry in the array\n          trial[param].forEach(function (ip, i) {\n            // check each parameter in the plugin description\n            for (const p in trial.type.info.parameters[param].nested) {\n              if (typeof trial[param][i][p] === \"undefined\" || trial[param][i][p] === null) {\n                if (typeof trial.type.info.parameters[param].nested[p].default === \"undefined\") {\n                  console.error(\n                    \"You must specify a value for the \" +\n                      p +\n                      \" parameter (nested in the \" +\n                      param +\n                      \" parameter) in the \" +\n                      trial.type +\n                      \" plugin.\"\n                  );\n                } else {\n                  trial[param][i][p] = trial.type.info.parameters[param].nested[p].default;\n                }\n              }\n            }\n          });\n        }\n      }\n      // if it's not nested, checking is much easier and do that here:\n      else if (typeof trial[param] === \"undefined\" || trial[param] === null) {\n        if (typeof trial.type.info.parameters[param].default === \"undefined\") {\n          console.error(\n            \"You must specify a value for the \" +\n              param +\n              \" parameter in the \" +\n              trial.type.info.name +\n              \" plugin.\"\n          );\n        } else {\n          trial[param] = trial.type.info.parameters[param].default;\n        }\n      }\n    }\n  }\n\n  private async checkExclusions(exclusions) {\n    // MINIMUM SIZE\n    if (exclusions.min_width || exclusions.min_height) {\n      const mw = exclusions.min_width || 0;\n      const mh = exclusions.min_height || 0;\n\n      if (window.innerWidth < mw || window.innerHeight < mh) {\n        this.getDisplayElement().innerHTML =\n          \"<p>Your browser window is too small to complete this experiment. \" +\n          \"Please maximize the size of your browser window. If your browser window is already maximized, \" +\n          \"you will not be able to complete this experiment.</p>\" +\n          \"<p>The minimum width is \" +\n          mw +\n          \"px. Your current width is \" +\n          window.innerWidth +\n          \"px.</p>\" +\n          \"<p>The minimum height is \" +\n          mh +\n          \"px. Your current height is \" +\n          window.innerHeight +\n          \"px.</p>\";\n\n        // Wait for window size to increase\n        while (window.innerWidth < mw || window.innerHeight < mh) {\n          await delay(100);\n        }\n\n        this.getDisplayElement().innerHTML = \"\";\n      }\n    }\n\n    // WEB AUDIO API\n    if (typeof exclusions.audio !== \"undefined\" && exclusions.audio) {\n      if (!window.hasOwnProperty(\"AudioContext\") && !window.hasOwnProperty(\"webkitAudioContext\")) {\n        this.getDisplayElement().innerHTML =\n          \"<p>Your browser does not support the WebAudio API, which means that you will not \" +\n          \"be able to complete the experiment.</p><p>Browsers that support the WebAudio API include \" +\n          \"Chrome, Firefox, Safari, and Edge.</p>\";\n        throw new Error();\n      }\n    }\n  }\n\n  private drawProgressBar(msg) {\n    document\n      .querySelector(\".jspsych-display-element\")\n      .insertAdjacentHTML(\n        \"afterbegin\",\n        '<div id=\"jspsych-progressbar-container\">' +\n          \"<span>\" +\n          msg +\n          \"</span>\" +\n          '<div id=\"jspsych-progressbar-outer\">' +\n          '<div id=\"jspsych-progressbar-inner\"></div>' +\n          \"</div></div>\"\n      );\n  }\n\n  private updateProgressBar() {\n    this.setProgressBar(this.getProgress().percent_complete / 100);\n  }\n\n  private progress_bar_amount = 0;\n\n  setProgressBar(proportion_complete) {\n    proportion_complete = Math.max(Math.min(1, proportion_complete), 0);\n    document.querySelector<HTMLElement>(\"#jspsych-progressbar-inner\").style.width =\n      proportion_complete * 100 + \"%\";\n    this.progress_bar_amount = proportion_complete;\n  }\n\n  getProgressBarCompleted() {\n    return this.progress_bar_amount;\n  }\n}\n","import autoBind from \"auto-bind\";\n\nimport { JsPsych } from \"../../JsPsych\";\nimport { HardwareAPI } from \"./HardwareAPI\";\nimport { KeyboardListenerAPI } from \"./KeyboardListenerAPI\";\nimport { MediaAPI } from \"./MediaAPI\";\nimport { TimeoutAPI } from \"./TimeoutAPI\";\n\nexport function createJointPluginAPIObject(jsPsych: JsPsych) {\n  const settings = jsPsych.getInitSettings();\n  return Object.assign(\n    {},\n    ...[\n      new KeyboardListenerAPI(\n        jsPsych.getDisplayContainerElement,\n        settings.case_sensitive_responses,\n        settings.minimum_valid_rt\n      ),\n      new TimeoutAPI(),\n      new MediaAPI(settings.use_webaudio, jsPsych.webaudio_context),\n      new HardwareAPI(),\n    ].map((object) => autoBind(object))\n  ) as KeyboardListenerAPI & TimeoutAPI & MediaAPI & HardwareAPI;\n}\n\nexport type PluginAPI = ReturnType<typeof createJointPluginAPIObject>;\n","import { JsPsych } from \"./JsPsych\";\n\n// temporary patch for Safari\nif (\n  typeof window !== \"undefined\" &&\n  window.hasOwnProperty(\"webkitAudioContext\") &&\n  !window.hasOwnProperty(\"AudioContext\")\n) {\n  // @ts-expect-error\n  window.AudioContext = webkitAudioContext;\n}\n// end patch\n\n// The following function provides a uniform interface to initialize jsPsych, no matter whether a\n// browser supports ES6 classes or not (and whether the ES6 build or the Babel build is used).\n/**\n * Creates a new JsPsych instance using the provided options.\n *\n * @param options The options to pass to the JsPsych constructor\n * @returns A new JsPsych instance\n */\nexport function initJsPsych(options?) {\n  return new JsPsych(options);\n}\n\nexport { JsPsych } from \"./JsPsych\";\nexport {\n  JsPsychPlugin,\n  PluginInfo,\n  TrialType,\n  ParameterType,\n  universalPluginParameters,\n  UniversalPluginParameters,\n} from \"./modules/plugins\";\nexport { JsPsychExtension, JsPsychExtensionInfo } from \"./modules/extensions\";\n"],"names":["__awaiter","thisArg","_arguments","P","generator","Promise","resolve","reject","fulfilled","value","step","next","e","rejected","result","done","then","apply","getAllProperties","object","properties","Set","Reflect","ownKeys","key","add","getPrototypeOf","Object","prototype","autoBind","self","include","exclude","filter","match","pattern","test","some","constructor","descriptor","getOwnPropertyDescriptor","bind","unique","arr","deepCopy","obj","out","Array","isArray","x","push","hasOwnProperty","ParameterType","DataColumn","values","this","sum","s","v","mean","count","median","length","numbers","slice","sort","a","b","middle","Math","floor","min","max","variance","sum_square_error","pow","sd","mse","sqrt","frequencies","all","eval_fn","subset","DataCollection","data","trials","new_data","join","other_data_collection","concat","top","first","n","last","readOnly","addToAll","trial","assign","addToLast","filters","f","filtered_data","keep","keys","filterCustom","fn","select","column","ignore","columns","o","delete_key","uniqueNames","names","includes","csv","objArray","array","JSON","parse","line","row","keyString","replace","col","stringify","JSON2CSV","json","pretty","localSave","format","filename","data_string","toLowerCase","Error","textstr","blobToSave","Blob","type","blobURL","window","webkitURL","createObjectURL","URL","link","document","createElement","id","style","display","download","href","click","saveTextToFile","JsPsychData","jsPsych","reset","allData","interactionData","get","getInteractionData","write","data_object","progress","getProgress","getCurrentTrial","default_data","trial_type","info","name","trial_index","current_trial_global","time_elapsed","getTotalTime","internal_node_id","getCurrentTimelineNodeID","dataProperties","addProperties","addDataToLastTrial","getDataByTimelineNode","node_id","getLastTrialData","getLastTimelineData","parent_node_id","substr","lastIndexOf","displayData","console","log","getDisplayElement","innerHTML","getElementById","textContent","urlVariables","query_string","location","search","split","i","p","decodeURIComponent","getQueryString","getURLVariable","whichvar","createInteractionListeners","addEventListener","event","time","getInitSettings","on_interaction_data_update","fullscreenchange","isFullScreen","webkitIsFullScreen","mozIsFullScreen","fullscreenElement","_customInsert","_fullreset","HardwareAPI","evt","hardwareConnected","hardware","mess","jspsychEvt","CustomEvent","detail","dispatchEvent","KeyboardListenerAPI","getRootElement","areResponsesCaseSensitive","minimumValidRt","registerRootListeners","areRootListenersRegistered","rootElement","rootKeydownListener","rootKeyupListener","listener","from","listeners","heldKeys","toLowerCaseIfInsensitive","string","delete","isResponseValid","validResponses","allowHeldKey","has","getKeyboardResponse","callback_function","valid_responses","rt_method","persist","audio_context","audio_context_start_time","allow_held_key","minimum_valid_rt","startTime","performance","now","map","r","rt","round","currentTime","preventDefault","cancelKeyboardResponse","cancelAllKeyboardResponses","clear","compareKeys","key1","key2","error","universalPluginParameters","OBJECT","pretty_name","default","on_start","FUNCTION","on_finish","on_load","post_trial_gap","INT","css_classes","STRING","preloadParameterTypes","AUDIO","IMAGE","VIDEO","MediaAPI","useWebaudio","webaudioContext","Map","getVideoBuffer","videoID","video_buffers","initAudio","context","audioContext","state","resume","getAudioBuffer","audioID","audio_buffers","preloadAudio","files","callback_complete","callback_load","filepath","callback_error","error_msg","flat","n_loaded","load_audio_file_webaudio","source","request","XMLHttpRequest","open","responseType","onload","decodeAudioData","response","buffer","onerror","err","status","onloadend","send","preload_requests","load_audio_file_html5audio","audio","Audio","handleCanPlayThrough","removeEventListener","handleError","src","handleAbort","file","preloadImages","images","img","Image","img_cache","preloadVideo","videos","video","videoBlob","getAutoPreloadList","timeline_description","preloadPaths","fromEntries","traverseTimeline","node","inheritedTrialType","timeline","childNode","pluginName","parameters","preloadMap","set","entries","_name","preload","parameterName","parameterType","parameterValue","elements","element","cancelPreloads","oncanplaythrough","onabort","TimeoutAPI","setTimeout","callback","delay","handle","timeout_handlers","clearAllTimeouts","handler","clearTimeout","repeat","repetitions","unpack","arr_isArray","rep_isArray","warn","reps","allsamples","j","shuffle","unpackArray","copy_array","t","m","random","shuffleAlternateGroups","arr_groups","random_group_order","n_groups","group_order","randomized_groups","min_length","sampleWithoutReplacement","size","sampleWithReplacement","weights","normalized_weights","weight_sum","weight","cumulative_weights","samp","rnd","index","equalityTest","random_shuffle","random_pick","new_neighbor","factors","design","factorName","factor","new_design","level","cell","chars","turkInfo","turk","previewMode","outsideTurk","hitId","assignmentId","workerId","turkSubmitTo","param","url","results","RegExp","exec","referrer","unescape","form","method","action","hiddenField","appendChild","body","submit","TimelineNode","parent","relativeID","current_location","current_variable_set","current_repetition","current_iteration","parent_node","relative_id","timeline_parameters","loop_function","conditional_function","sample","randomize_order","timeline_variables","on_timeline_finish","on_timeline_start","setTimelineVariablesOrder","node_data","node_trial_data","merged_parameters","merged_data","trial_parameters","markCurrentTrialComplete","nextRepetiton","order","groups","randomize_group_order","nextSet","advance","internal","call_immediate","conditional_result","have_node_to_run","generatedData","isComplete","getTimelineVariableValue","variable_name","findTimelineVariable","timelineVariable","loc","allTimelineVariables","all_tvs","allTimelineVariablesNames","all_tvs_vals","so_far","percentComplete","total_trials","completed_trials","end","endActiveNode","ID","activeID","trialsOfType","insert","ms","JsPsych","options","randomization","utils","display_element","undefined","on_trial_start","on_trial_finish","on_data_update","on_close","use_webaudio","exclusions","show_progress_bar","message_progress_bar","auto_update_progress_bar","default_iti","experiment_width","override_safe_mode","case_sensitive_responses","extensions","opts","webaudio_context","AudioContext","protocol","file_protocol","pluginAPI","settings","getDisplayContainerElement","createJointPluginAPIObject","extension","version","run","timelineDescription","prepareDom","checkExclusions","loadExtensions","documentElement","setAttribute","startExperiment","finished","global_trial_index","percent_complete","getStartTime","exp_start_time","Date","getTime","DOM_target","DOM_container","finishTrial","current_trial_finished","current_trial","classList","remove","trial_data_values","save_trial_parameters","key_val","toString","ext_data_values","params","nextTrial","endExperiment","end_message","endCurrentTimeline","varname","immediate","timelineVariablePlaceholder","timelineVariableFunction","getAllTimelineVariables","addNodeToEndOfTimeline","new_timeline","preload_callback","pauseExperiment","paused","resumeExperiment","waiting","loadFail","message","getSafeModeStatus","getTimeline","readyState","querySelector","height","margin","width","Element","tabIndex","className","indexOf","initialize","error_message","resolveFinishedPromise","drawProgressBar","doTrial","finishExperiment","finish_result","done_handler","complete","updateProgressBar","evaluateTimelineVariables","evaluateFunctionParameters","setDefaultValues","focus","scrollTop","load_callback","trial_complete","replaceFunctionsWithValues","nested","COMPLEX","forEach","ip","min_width","min_height","mw","mh","innerWidth","innerHeight","msg","insertAdjacentHTML","setProgressBar","proportion_complete","progress_bar_amount","getProgressBarCompleted","webkitAudioContext"],"mappings":"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"}